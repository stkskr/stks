/* ============================================
   MOBILE FIXES - Critical iPhone Layout Issues
   ============================================

   Addresses:
   1. Horizontal scrolling from 100vw elements
   2. Content cutoff under headers (vh → dvh)
   3. Carousel centering issues
   4. Modal layout problems

   Applied at: <= 768px (mobile)
   ============================================ */

/* =========================================
   NARROW VIEWPORT FULL-WIDTH BREAKOUTS
   ========================================= */

/* For narrow desktop and tablet screens */
@media (max-width: 1000px) {
  .client-marquee-container,
  .space-gallery-container,
  .testimonials-section,
  .cta-section {
    width: 100vw !important;
    max-width: 100vw !important;
    position: relative !important;
    left: 50% !important;
    right: 50% !important;
    margin-left: -50vw !important;
    margin-right: -50vw !important;
  }

  /* Quote carousel stays centered (not edge-to-edge) */
  .quote-carousel-container {
    width: 100% !important;
    max-width: 900px !important;
    margin-left: auto !important;
    margin-right: auto !important;
  }

  /* CTA section needs padding for content */
  .cta-section {
    padding-left: 40px !important;
    padding-right: 40px !important;
  }

  /* Testimonials section: edge-to-edge with no padding */
  .testimonials-section {
    padding-left: 0 !important;
    padding-right: 0 !important;
  }
}

/* ===========================
   1. HORIZONTAL SCROLL FIXES
   =========================== */

/* Prevent body/html horizontal overflow */
@media (max-width: 768px) {
  html, body {
    max-width: 100%;
    overflow-x: hidden;
    position: relative;
  }

  /* Enable full-width breakout on mobile */
  .client-marquee-container,
  .space-gallery-container,
  .testimonials-section,
  .cta-section {
    width: 100vw !important;
    max-width: 100vw !important;
    position: relative !important;
    left: 50% !important;
    right: 50% !important;
    margin-left: -50vw !important;
    margin-right: -50vw !important;
  }

  /* Quote carousel stays centered on mobile (not edge-to-edge) */
  .quote-carousel-container {
    width: 100% !important;
    max-width: 100% !important;
    margin-left: 0 !important;
    margin-right: 0 !important;
    left: auto !important;
    right: auto !important;
    position: relative !important;
  }

  /* CTA section needs padding restored for content */
  .cta-section {
    padding-left: 40px !important;
    padding-right: 40px !important;
    /* Extra padding for Chrome/Samsung bottom UI bars + safe area */
    padding-bottom: calc(200px + env(safe-area-inset-bottom)) !important;
  }

  /* Testimonials section: edge-to-edge with no padding */
  .testimonials-section {
    padding-left: 0 !important;
    padding-right: 0 !important;
  }

  /* Company download button: More compact on mobile */
  .company-download-btn {
    padding: 14px 24px !important;
    font-size: 0.9rem !important;
    gap: 8px !important;
  }

  /* Fix portfolio modal sizing */
  .portfolio-modal {
    width: 100% !important;
    max-width: 100vw;
    height: 100dvh !important;
    /* Reduce padding on mobile to give more space to content */
    padding: 20px 10px !important;
    /* CHANGED: touch-action: none was blocking scroll when overlay hit-testing failed
       Let touch events pass through to children instead */
    touch-action: auto !important;
  }

  /* Modal content should allow vertical panning */
  .portfolio-modal .modal-content {
    touch-action: pan-y !important;
  }

  /* CRITICAL: Override the .active transform rule from desktop CSS
     Even scale(1) can break nested scroll on iOS Safari */
  .portfolio-modal.active .modal-content {
    transform: none !important;
  }

  /* Fix video modal width */
  .video-modal {
    width: 100% !important;
    max-width: 100vw;
  }
}

/* =====================================
   2. CONTENT CUTOFF FIXES (vh → dvh)
   ===================================== */

@media (max-width: 768px) {
  /* Bottom tabs: Use dvh instead of vh to account for address bar */
  .bottom-tab-panel.faq-panel {
    height: calc(80dvh + 42px) !important;
    bottom: calc(-80dvh) !important;
  }

  .bottom-tab-panel.contact-panel {
    height: calc(80dvh + 42px) !important;
    bottom: calc(-80dvh) !important;
  }

  /* Content box: Use dvh for proper positioning */
  .stateExpanding .content-box {
    top: 80dvh !important;
    min-height: 20dvh !important;
    padding-top: 0 !important;
    z-index: 100 !important;
    position: absolute !important;
  }

  /* Ensure content-inner has proper top spacing */
  .content-inner {
    padding-top: 40px !important;
    margin-top: 0 !important;
  }

  /* First element in content should have extra margin */
  .content-inner > *:first-child {
    margin-top: 20px !important;
  }

  /* Ensure sub-quadrants don't overflow their bounds */
  .sub-quadrant {
    max-height: 40dvh !important;
    overflow: hidden !important;
  }

  /* Modal content: Adjust for mobile address bar and ensure proper scrolling */
  .modal-content {
    /* Let modal fit content, but don't exceed viewport */
    height: auto !important;
    max-height: calc(100dvh - 120px) !important;
    /* Fill parent width (parent has 10px side padding) */
    width: 100% !important;
    max-width: 100% !important;
    /* Ensure flexbox layout for scrollable body */
    display: flex !important;
    flex-direction: column !important;
    /* Prevent the modal itself from scrolling */
    overflow: hidden !important;
    /* Remove transform scaling on mobile - causes touch scrolling issues */
    transform: none !important;
    will-change: auto !important;
    /* CRITICAL: Disable ALL transitions on mobile - height transitions break touch scrolling in WebKit */
    transition: none !important;
  }
}

/* ============================
   3. CAROUSEL CENTERING FIXES
   ============================ */

@media (max-width: 768px) {
  /* Quote carousel: Full width on mobile */
  .quote-carousel-container {
    width: 100% !important;
    max-width: 100% !important;
    margin: 20px 0 !important;
    padding: 0 !important;
    box-sizing: border-box !important;
    overflow: hidden !important;
    overflow-x: clip !important; /* Better than hidden for subpixel rendering */
  }

  /* Ensure carousel track doesn't overflow */
  .carousel-track {
    width: 100% !important;
    display: flex !important;
    margin: 0 !important;
    padding: 0 !important;
    gap: 0 !important;
  }

  /* Ensure each slide is properly sized - exactly 100% */
  .quote-slide {
    width: 100% !important;
    min-width: 100% !important;
    max-width: 100% !important;
    flex-shrink: 0 !important;
    flex-grow: 0 !important;
    box-sizing: border-box !important;
    margin: 0 !important;
    padding: 0 !important;
    border: none !important;
  }

  /* Quote boxes should have padding instead of container margin */
  .quote-box-dark,
  .author-box-light {
    padding-left: 20px !important;
    padding-right: 20px !important;
    box-sizing: border-box !important;
    width: 100% !important;
    max-width: 100% !important;
  }

  /* Remove borders that add to width on mobile */
  .author-box-light {
    border-left: 1px solid #eee !important;
  }

  /* Modal carousel: Let active image determine height on mobile */

  /* Kill the desktop spacer - thoroughly */
  .modal-carousel-container::before {
    display: none !important;
    content: none !important;
    height: 0 !important;
    max-height: 0 !important;
    min-height: 0 !important;
    padding: 0 !important;
    margin: 0 !important;
    visibility: hidden !important;
    position: absolute !important;
  }

  /* Let the container size naturally */
  .modal-carousel-container {
    margin-bottom: 15px !important;
    background: transparent !important;
    /* CRITICAL FIX: overflow: visible allowed absolutely positioned controls
       to extend outside and create touch dead zones over the text content below */
    overflow: hidden !important;
    height: auto !important;
    min-height: 0 !important;
    /* Allow vertical panning for scroll */
    touch-action: pan-y !important;
  }

  /* Stop absolutely filling a fake height */
  .modal-carousel {
    position: relative !important;
    width: 100% !important;
    height: auto !important;
    min-height: 0 !important;
    touch-action: pan-y !important;
    overflow: hidden !important;
  }

  /* Default: slides hidden and absolutely positioned (don't take up space) */
  .modal-carousel-item {
    display: block !important;
    position: absolute !important;
    top: 0 !important;
    left: 0 !important;
    visibility: hidden !important;
    opacity: 0 !important;
    width: 100% !important;
    height: auto !important;
    min-height: 0 !important;
    max-height: none !important;
    /* Reset any flex centering from desktop */
    align-items: initial !important;
    justify-content: initial !important;
  }

  /* Active slide: visible and in normal flow (relative positioning defines height) */
  .modal-carousel-item.active {
    display: block !important;
    position: relative !important;
    visibility: visible !important;
    opacity: 1 !important;
    z-index: 2 !important;
    touch-action: pan-y !important;
    /* Override desktop flex centering */
    align-items: initial !important;
    justify-content: initial !important;
    height: auto !important;
  }

  /* Reset desktop animations only when NOT animating */
  .modal-carousel-item.active:not(.enter-next):not(.enter-prev):not(.is-animating) {
    animation: none !important;
  }

  /* EXITING item: stays position:relative to maintain container height during animation */
  /* It animates (fades/slides) but keeps the layout stable */
  .modal-carousel-item.is-animating.exit-next,
  .modal-carousel-item.is-animating.exit-prev {
    position: relative !important;
    visibility: visible !important;
    z-index: 1 !important;
    pointer-events: none !important;
    display: block !important;
    align-items: initial !important;
    justify-content: initial !important;
    height: auto !important;
  }

  .modal-carousel-item.is-animating.exit-next {
    animation: mobileSlideOutLeft 0.4s ease-out forwards !important;
  }

  .modal-carousel-item.is-animating.exit-prev {
    animation: mobileSlideOutRight 0.4s ease-out forwards !important;
  }

  /* ENTERING item: position:absolute overlay on top of exiting item */
  .modal-carousel-item.is-animating.enter-next,
  .modal-carousel-item.is-animating.enter-prev {
    position: absolute !important;
    top: 0 !important;
    left: 0 !important;
    width: 100% !important;
    visibility: visible !important;
    z-index: 3 !important;
    pointer-events: none !important;
    display: block !important;
    align-items: initial !important;
    justify-content: initial !important;
    height: auto !important;
  }

  .modal-carousel-item.is-animating.enter-next {
    animation: mobileSlideInRight 0.4s ease-out forwards !important;
  }

  .modal-carousel-item.is-animating.enter-prev {
    animation: mobileSlideInLeft 0.4s ease-out forwards !important;
  }
}

/* Mobile carousel slide animations - defined outside media query for browser compatibility */
@keyframes mobileSlideInRight {
  0% {
    opacity: 0;
    transform: translateX(100%);
  }
  100% {
    opacity: 1;
    transform: translateX(0);
  }
}

@keyframes mobileSlideInLeft {
  0% {
    opacity: 0;
    transform: translateX(-100%);
  }
  100% {
    opacity: 1;
    transform: translateX(0);
  }
}

@keyframes mobileSlideOutLeft {
  0% {
    opacity: 1;
    transform: translateX(0);
  }
  100% {
    opacity: 0;
    transform: translateX(-100%);
  }
}

@keyframes mobileSlideOutRight {
  0% {
    opacity: 1;
    transform: translateX(0);
  }
  100% {
    opacity: 0;
    transform: translateX(100%);
  }
}

@media (max-width: 768px) {

  /* Also ensure non-active items never block touches */
  .modal-carousel-item:not(.active) {
    pointer-events: none !important;
  }

  /* Make images fill width, cap height, and remove desktop min-height */
  .modal-carousel-item img {
    width: 100% !important;
    height: auto !important;
    max-height: 60vh !important;
    min-height: 0 !important;
    max-width: 100% !important;
    object-fit: contain !important;
    display: block !important;
    touch-action: pan-y !important;
  }

  /* Also fix single image container - kill desktop min-height: 550px */
  .modal-image-container {
    margin-bottom: 15px !important;
    overflow: visible !important;
    height: auto !important;
    min-height: 0 !important;
    /* Kill flex centering that creates extra space */
    display: block !important;
    background: transparent !important;
    touch-action: pan-y !important;
  }

  .modal-image-container::before {
    display: none !important;
    content: none !important;
    height: 0 !important;
    max-height: 0 !important;
    min-height: 0 !important;
    padding: 0 !important;
    margin: 0 !important;
    visibility: hidden !important;
    position: absolute !important;
  }

  .modal-image-container img {
    width: 100% !important;
    height: auto !important;
    max-height: 60vh !important;
    min-height: 0 !important;
    object-fit: contain !important;
    display: block !important;
    touch-action: pan-y !important;
  }

  /* Carousel navigation buttons: Increase tap target size */
  .modal-carousel-prev,
  .modal-carousel-next {
    width: 44px;
    height: 44px;
    min-width: 44px;
    min-height: 44px;
    /* Reduce gesture fighting - only respond to taps, not interfere with pan */
    touch-action: manipulation !important;
  }

  .modal-carousel-prev {
    left: 10px !important;
  }

  .modal-carousel-next {
    right: 10px !important;
  }

  /* Carousel indicators: Also use manipulation to prevent blocking scroll */
  .modal-carousel-indicators {
    touch-action: manipulation !important;
  }

  /* Carousel dots: Make them larger for touch */
  .modal-carousel-dots {
    bottom: 10px;
  }

  .modal-carousel-dot {
    width: 10px;
    height: 10px;
    margin: 0 6px;
  }
}

/* =======================
   4. MODAL LAYOUT FIXES
   ======================= */

@media (max-width: 768px) {
  /* Modal header: Keep 3-column grid but tighter spacing */
  .modal-header {
    grid-template-columns: 1fr auto 1fr !important;
    gap: 8px;
    padding: 12px 15px;
    align-items: center;
    /* Ensure header doesn't shrink */
    flex-shrink: 0 !important;
  }

  /* Nav buttons should stay on the left */
  .modal-nav {
    justify-self: start !important;
  }

  /* Language toggle stays centered */
  .modal-language-toggle {
    justify-self: center !important;
  }

  /* Header actions (just close button now) should stay on the right */
  .modal-header-actions {
    justify-self: end !important;
  }

  /* Nav buttons: Smaller and tighter */
  .modal-nav {
    gap: 8px !important;
  }

  .modal-nav-btn {
    width: 36px !important;
    height: 36px !important;
    min-width: 36px !important;
  }

  /* Language toggle: Smaller text */
  .modal-language-toggle {
    font-size: 13px !important;
  }

  /* Header actions (keyboard + close): Tighter */
  .modal-header-actions {
    gap: 6px !important;
  }

  /* Hide keyboard icon on mobile */
  .modal-hotkey-btn {
    display: none !important;
  }

  .modal-close-btn {
    width: 36px !important;
    height: 36px !important;
    min-width: 36px !important;
  }

  /* Modal body: Content-fitting with scroll when needed */
  .modal-body {
    padding: 15px !important;
    /* Scroll only when content exceeds available space */
    overflow-y: auto !important;
    overflow-x: hidden !important;
    -webkit-overflow-scrolling: touch !important;
    /* Prevent scroll chaining to background */
    overscroll-behavior: contain !important;
    position: relative !important;
    /* Content-fitting: don't grow beyond content, but can shrink */
    flex: 1 1 auto !important;
    min-height: 0 !important; /* Allow shrinking below content size */
    /* Allow vertical panning */
    touch-action: pan-y !important;
    scroll-behavior: auto !important;
    /* CRITICAL: Disable transitions */
    transition: none !important;
    /* Disable text selection to prevent it from blocking scroll */
    -webkit-user-select: none !important;
    user-select: none !important;
  }

  /* Re-enable text selection for actual copyable content if needed */
  .modal-body .modal-info-item p {
    -webkit-user-select: text !important;
    user-select: text !important;
  }

  /* Remove excessive margins from modal content */
  .modal-carousel-container,
  .modal-image-container,
  .modal-video-container {
    margin-bottom: 15px !important;
  }

  /* Modal info: Single column on mobile */
  .modal-info {
    grid-template-columns: 1fr !important;
    gap: 15px;
  }

  /* Modal info item: Full width */
  .modal-info-item {
    min-width: 0 !important;
  }

  /* Explicitly ensure title and text content allow scroll */
  .modal-title,
  .modal-info,
  .modal-info-item,
  .modal-info-item h3,
  .modal-info-item p,
  .modal-meta,
  .modal-meta-item,
  .modal-meta-label {
    touch-action: pan-y !important;
    -webkit-touch-callout: none !important;
  }

  /* Modal meta: Stack items on separate lines, keep label/value together */
  .modal-meta {
    flex-direction: column !important;
    gap: 8px !important;
    font-size: 12px !important;
    padding-top: 20px !important;
  }

  .modal-meta-item {
    flex-direction: row !important;
    gap: 6px !important;
    align-items: baseline !important;
  }

  .modal-meta-label {
    font-size: 12px !important;
  }

  /* Video modal: Reduce padding */
  .video-modal-content {
    width: 95%;
    max-width: calc(100vw - 40px);
    padding: 10px;
  }

  /* Hotkey modal: Single column */
  .hotkey-sections,
  .hotkey-sections-vertical {
    grid-template-columns: 1fr !important;
    gap: 20px;
  }

  /* Hide vertical divider line on mobile */
  .hotkey-sections-vertical::after,
  .hotkey-sections::after {
    display: none !important;
  }
}

/* ============================
   5. BOTTOM TABS MOBILE FIXES
   ============================ */

@media (max-width: 768px) {
  /* Bottom tabs: Remove complex width calculations */
  .bottom-tabs {
    width: 100% !important;
    max-width: 100%;
    left: 0;
    transform: none;
  }

  .bottom-tab-panel {
    width: 100% !important;
    max-width: 100%;
    left: 0;
    transform: none;
  }
}

/* ===================
   6. GRID FIXES
   =================== */

@media (max-width: 768px) {
  /* Team grid: Single column on mobile */
  .team-grid {
    grid-template-columns: 1fr !important;
    gap: 20px;
  }

  .team-member {
    width: 100% !important;
    max-width: 100%;
  }

  /* Portfolio grid: Single column on mobile */
  .portfolio-grid {
    grid-template-columns: 1fr !important;
    gap: 10px;
  }

  /* Space gallery: Single column on mobile */
  .space-gallery-grid {
    grid-template-columns: 1fr !important;
    gap: 15px;
  }

  /* CTA heading: Keep "Have a project?" on one line */
  .cta-heading {
    font-size: 2.2rem !important;
    white-space: nowrap !important;
  }
}

/* ================================
   7. FIXED UI ELEMENTS (NOTCH SAFE)
   ================================ */

@media (max-width: 768px) {
  /* Language toggle: Account for notch */
  .language-toggle {
    top: max(30px, env(safe-area-inset-top)) !important;
    left: max(20px, env(safe-area-inset-left)) !important;
  }

  /* Audio toggle: Account for notch */
  .audio-toggle {
    top: max(24px, env(safe-area-inset-top)) !important;
    right: max(20px, env(safe-area-inset-right)) !important;
  }
}

/* =========================
   8. TESTIMONIALS MOBILE FIX
   ========================= */

@media (max-width: 900px) {
  .testimonials-section {
    padding: 40px 20px !important;
  }

  .testimonial-card {
    padding: 25px 20px;
  }
}

/* ======================
   9. CONTENT BOX PADDING
   ====================== */

@media (max-width: 768px) {
  .content-box {
    padding-left: 20px;
    padding-right: 20px;
  }

  .section-content {
    padding: 30px 0;
  }
}

/* ==========================
   10. SAFE AREA INSETS (iOS)
   ========================== */

@media (max-width: 768px) {
  /* Apply safe area insets to body */
  body {
    padding-left: env(safe-area-inset-left);
    padding-right: env(safe-area-inset-right);
  }

  /* Apply to bottom tabs */
  .bottom-tabs {
    padding-bottom: env(safe-area-inset-bottom);
  }

  /* Show copy buttons always on mobile (no hover state) */
  .copy-btn {
    opacity: 1 !important;
    transform: translateX(0) !important;
  }

  /* About page: smaller title and subtitle on mobile */
  .about-title {
    font-size: 1.1em !important;
  }

  .about-subtitle {
    font-size: 0.95rem !important;
    line-height: 28px !important;
  }
}
