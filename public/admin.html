<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>STKS Admin</title>
  <meta name="robots" content="noindex, nofollow">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect width='32' height='32' rx='4' fill='%2319334a'/><text x='16' y='23' font-family='Poppins,sans-serif' font-size='20' font-weight='700' fill='white' text-anchor='middle'>S</text></svg>">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    @font-face { font-family: 'Pretendard'; font-weight: 400; src: url('/assets/fonts/pretendard/Pretendard-Regular.woff2') format('woff2'); }
    @font-face { font-family: 'Pretendard'; font-weight: 500; src: url('/assets/fonts/pretendard/Pretendard-Medium.woff2') format('woff2'); }
    @font-face { font-family: 'Pretendard'; font-weight: 600; src: url('/assets/fonts/pretendard/Pretendard-SemiBold.woff2') format('woff2'); }
    @font-face { font-family: 'Pretendard'; font-weight: 700; src: url('/assets/fonts/pretendard/Pretendard-Bold.woff2') format('woff2'); }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Poppins', 'Pretendard', system-ui, -apple-system, sans-serif;
      background: #f4f4f4;
      color: #333;
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Header */
    .header {
      background: #19334a;
      color: #fff;
      padding: 12px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .header-left { display: flex; align-items: center; gap: 10px; }
    .header-logo {
      width: 28px;
      height: 28px;
      filter: brightness(0) invert(1);
    }
    .header h1 { font-size: 18px; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; }
    .header-right { display: flex; align-items: center; gap: 12px; font-size: 14px; }
    .header-right .username { opacity: 0.8; }

    /* Buttons */
    button, select, input, textarea {
      font-family: inherit;
    }
    button {
      cursor: pointer;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      padding: 8px 16px;
      transition: background 0.2s, opacity 0.2s;
    }
    button:disabled { opacity: 0.5; cursor: not-allowed; }

    .btn-primary { background: #a11d20; color: #fff; }
    .btn-primary:hover:not(:disabled) { background: #8a1618; }

    .btn-danger { background: #ef4444; color: #fff; }
    .btn-danger:hover:not(:disabled) { background: #dc2626; }

    .btn-outline {
      background: transparent;
      border: 1px solid #d1d5db;
      color: #374151;
    }
    .btn-outline:hover:not(:disabled) { background: #f3f4f6; }

    .btn-ghost { background: transparent; color: #fff; padding: 6px 12px; }
    .btn-ghost:hover { background: rgba(255,255,255,0.1); }

    .btn-small { padding: 4px 10px; font-size: 12px; }

    /* Login screen */
    .login-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      gap: 24px;
    }
    .login-screen h1 { font-size: 28px; color: #19334a; font-weight: 700; letter-spacing: 3px; text-transform: uppercase; }
    .login-screen p { color: #6b7280; }
    .login-btn {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 14px 28px;
      font-size: 15px;
      font-weight: 600;
      background: #19334a;
      color: #fff;
      border-radius: 6px;
      letter-spacing: 0.3px;
    }
    .login-btn:hover { background: #122639; }
    .login-btn svg { width: 20px; height: 20px; fill: #fff; }

    .error-msg {
      background: #fef2f2;
      color: #991b1b;
      padding: 12px 20px;
      border-radius: 8px;
      border: 1px solid #fecaca;
    }

    /* Dashboard */
    .dashboard { display: none; }
    .dashboard.visible { display: block; }

    /* Tab navigation */
    .tab-nav {
      display: flex;
      gap: 4px;
      padding: 12px 24px 0;
      background: #fff;
      border-bottom: 1px solid #e5e7eb;
      overflow-x: auto;
    }
    .tab-btn {
      padding: 10px 20px;
      background: transparent;
      border-radius: 8px 8px 0 0;
      color: #6b7280;
      font-weight: 500;
      border-bottom: 2px solid transparent;
      white-space: nowrap;
    }
    .tab-btn:hover { color: #374151; background: #f9fafb; }
    .tab-btn.active {
      color: #19334a;
      border-bottom-color: #a11d20;
      background: #f0f4f8;
      font-weight: 600;
    }

    /* Editor area */
    .editor-area {
      max-width: 1200px;
      margin: 24px auto;
      padding: 0 24px;
    }

    .editor-card {
      background: #fff;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      padding: 24px;
      margin-bottom: 16px;
    }

    .editor-card h3 {
      font-size: 16px;
      color: #111827;
      margin-bottom: 16px;
      padding-bottom: 8px;
      border-bottom: 1px solid #f3f4f6;
    }

    /* Bilingual field layout */
    .bilingual-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 16px;
    }
    .field-group { display: flex; flex-direction: column; gap: 4px; }
    .field-group label {
      font-size: 12px;
      font-weight: 600;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .field-group input,
    .field-group textarea {
      padding: 8px 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 14px;
      font-family: inherit;
      transition: border-color 0.2s;
    }
    .field-group input:focus,
    .field-group textarea:focus {
      outline: none;
      border-color: #19334a;
      box-shadow: 0 0 0 3px rgba(25,51,74,0.1);
    }
    .field-group textarea { resize: vertical; min-height: 80px; }

    .field-label-row {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .lang-badge {
      font-size: 10px;
      padding: 1px 6px;
      border-radius: 4px;
      font-weight: 700;
    }
    .lang-badge.ko { background: #fee2e2; color: #991b1b; }
    .lang-badge.en { background: #dcfce7; color: #166534; }

    /* Dirty tab indicator */
    .tab-btn.dirty { position: relative; }
    .tab-btn.dirty::after {
      content: '';
      position: absolute;
      top: 6px;
      right: 6px;
      width: 7px;
      height: 7px;
      background: #a11d20;
      border-radius: 50%;
    }

    /* Save bar */
    .save-bar {
      position: sticky;
      bottom: 0;
      background: #fff;
      border-top: 1px solid #e5e7eb;
      padding: 12px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      z-index: 50;
    }
    .save-status { font-size: 14px; color: #6b7280; }
    .save-status.success { color: #059669; }
    .save-status.error { color: #dc2626; }
    .save-status.saving { color: #d97706; }

    .btn-deploy { background: #19334a; color: #fff; }
    .btn-deploy:hover:not(:disabled) { background: #122639; }

    /* Array editor */
    .array-item {
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
      position: relative;
      background: #fafafa;
    }
    .array-item:hover { background: #f9fafb; }

    .array-item-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }
    .array-item-header .item-number {
      font-size: 13px;
      font-weight: 600;
      color: #6b7280;
    }
    .array-item-actions { display: flex; gap: 4px; }

    .array-controls {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }

    /* Single-value field (non-bilingual) */
    .single-field { margin-bottom: 16px; }

    /* Team member card */
    .team-profile-header {
      display: flex;
      gap: 28px;
      align-items: center;
      margin-bottom: 20px;
      padding: 16px 0;
    }
    .team-photo-wrapper {
      flex-shrink: 0;
      width: 140px;
      text-align: center;
      padding-left: 10px;
    }
    .team-diamond {
      width: 110px;
      height: 110px;
      position: relative;
      margin: 0 auto;
    }
    .team-diamond-shape {
      width: 100%;
      height: 100%;
      overflow: hidden;
      transform: rotate(45deg);
      border: 1px solid #ddd;
      background: #000;
    }
    .team-diamond-shape img {
      width: 142%;
      height: 142%;
      object-fit: cover;
      transform: rotate(-45deg) scale(1.1);
      position: absolute;
      top: -21%;
      left: -21%;
      filter: grayscale(100%);
      transition: filter 0.3s;
    }
    .team-diamond:hover .team-diamond-shape img {
      filter: grayscale(0%);
    }
    .team-diamond-initial {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 40px;
      font-weight: 300;
      color: rgba(255,255,255,0.85);
      z-index: 2;
      pointer-events: none;
      transition: opacity 0.3s;
    }
    .team-diamond:hover .team-diamond-initial {
      opacity: 0;
    }
    .team-photo-placeholder {
      width: 110px;
      height: 110px;
      transform: rotate(45deg);
      border: 2px dashed #d1d5db;
      background: #f9fafb;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto;
    }
    .team-photo-placeholder span {
      transform: rotate(-45deg);
      color: #9ca3af;
      font-size: 12px;
    }
    .team-photo-upload-btn {
      display: inline-block;
      margin-top: 18px;
      font-size: 11px;
      color: #19334a;
      cursor: pointer;
      text-decoration: underline;
      text-underline-offset: 2px;
    }
    .team-photo-upload-btn:hover { color: #a11d20; }
    .team-header-fields {
      flex: 1;
      min-width: 0;
      max-width: 600px;
    }
    .team-initial-field {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 12px;
    }
    .team-initial-field label {
      font-size: 12px;
      font-weight: 600;
      color: #6b7280;
    }
    .team-initial-field input {
      width: 48px;
      padding: 4px 8px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 14px;
      text-align: center;
      font-weight: 600;
    }
    .team-initial-field input:focus {
      outline: none;
      border-color: #19334a;
      box-shadow: 0 0 0 3px rgba(25,51,74,0.1);
    }
    .team-section {
      background: #f8f9fb;
      border: 1px solid #edf0f3;
      border-radius: 8px;
      padding: 12px 14px;
      margin-bottom: 12px;
    }
    .team-section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .team-section-header h4 {
      font-size: 13px;
      font-weight: 600;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .team-section .array-item {
      padding: 8px 10px;
      margin-bottom: 6px;
      border: 1px solid #e5e7eb;
      background: #fff;
    }
    .team-section .bilingual-row {
      gap: 10px;
    }
    .team-edu-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }
    .team-edu-row span {
      font-size: 11px;
      color: #b0b5bb;
    }

    /* Loading spinner */
    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Collapsible portfolio items */
    .portfolio-item {
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      margin-bottom: 8px;
      background: #fafafa;
      overflow: hidden;
    }
    .portfolio-item:hover { background: #f9fafb; }
    .portfolio-item-summary {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      cursor: pointer;
      user-select: none;
      gap: 12px;
    }
    .portfolio-item-summary:hover { background: #f3f4f6; }
    .portfolio-item-left {
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 0;
      flex: 1;
    }
    .portfolio-item-num {
      font-size: 12px;
      font-weight: 700;
      color: #9ca3af;
      min-width: 28px;
    }
    .portfolio-item-title {
      font-size: 14px;
      font-weight: 600;
      color: #111827;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .portfolio-item-meta {
      font-size: 12px;
      color: #6b7280;
      white-space: nowrap;
    }
    .portfolio-item-chevron {
      font-size: 12px;
      color: #9ca3af;
      transition: transform 0.2s;
      flex-shrink: 0;
    }
    .portfolio-item.expanded .portfolio-item-chevron { transform: rotate(90deg); }
    .portfolio-item-body {
      display: none;
      padding: 0 16px 16px;
      border-top: 1px solid #f3f4f6;
    }
    .portfolio-item.expanded .portfolio-item-body { display: block; }

    /* Media type checkboxes */
    .media-type-group {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 4px;
    }
    .media-type-group label {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 13px;
      font-weight: 500;
      color: #374151;
      cursor: pointer;
      padding: 4px 10px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      background: #fff;
      transition: background 0.15s, border-color 0.15s;
      text-transform: capitalize;
    }
    .media-type-group label:hover { background: #f3f4f6; }
    .media-type-group input[type="checkbox"] { accent-color: #19334a; }
    .media-type-group input[type="checkbox"]:checked + span {
      color: #19334a;
      font-weight: 600;
    }

    /* Search/filter bar */
    .search-bar {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }
    .search-bar input {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 14px;
    }
    .search-bar input:focus {
      outline: none;
      border-color: #19334a;
      box-shadow: 0 0 0 3px rgba(25,51,74,0.1);
    }
    .search-bar .result-count {
      font-size: 13px;
      color: #6b7280;
      align-self: center;
      white-space: nowrap;
    }

    /* Image previews */
    .image-preview-section {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid #f3f4f6;
    }
    .image-preview-section h4 {
      font-size: 13px;
      font-weight: 600;
      color: #6b7280;
      margin-bottom: 8px;
    }
    .image-preview-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 8px;
      align-items: center;
    }
    .image-preview-item {
      position: relative;
      width: 120px;
      height: 80px;
      border-radius: 6px;
      overflow: hidden;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .image-preview-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .image-preview-item .remove-img {
      position: absolute;
      top: 2px;
      right: 2px;
      width: 18px;
      height: 18px;
      background: rgba(220,38,38,0.85);
      color: #fff;
      border: none;
      border-radius: 50%;
      font-size: 11px;
      line-height: 18px;
      text-align: center;
      cursor: pointer;
      display: none;
      padding: 0;
    }
    .image-preview-item:hover .remove-img { display: block; }
    .upload-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border: 1px dashed #d1d5db;
      border-radius: 6px;
      background: #fff;
      color: #6b7280;
      font-size: 13px;
      cursor: pointer;
    }
    .upload-btn:hover { border-color: #19334a; color: #19334a; }
    .upload-status {
      font-size: 12px;
      margin-top: 4px;
      min-height: 16px;
    }
    .upload-status.uploading { color: #d97706; }
    .upload-status.uploaded { color: #059669; }
    .upload-status.upload-error { color: #dc2626; }

    /* Drag and drop */
    .drag-handle {
      cursor: grab;
      color: #c0c0c0;
      font-size: 18px;
      line-height: 1;
      user-select: none;
      flex-shrink: 0;
    }
    .drag-handle:active { cursor: grabbing; }
    [data-drag-item].dragging { opacity: 0.25; }
    [data-drag-item].drag-over-top { box-shadow: inset 0 3px 0 0 #a11d20; }
    [data-drag-item].drag-over-bottom { box-shadow: inset 0 -3px 0 0 #a11d20; }

    /* Deploy modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 200;
    }
    .modal {
      background: #fff;
      border-radius: 12px;
      padding: 24px;
      max-width: 520px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    .modal h2 { font-size: 18px; margin-bottom: 16px; color: #111827; }
    .modal .change-list {
      list-style: none;
      margin-bottom: 16px;
      font-size: 14px;
      color: #374151;
    }
    .modal .change-list li {
      padding: 6px 0;
      border-bottom: 1px solid #f3f4f6;
    }
    .modal .change-list li::before {
      content: '\2022';
      color: #a11d20;
      margin-right: 8px;
      font-weight: bold;
    }
    .modal .field-label {
      font-size: 12px;
      font-weight: 600;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }
    .modal textarea {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 14px;
      font-family: inherit;
      resize: vertical;
      min-height: 60px;
      margin-bottom: 16px;
    }
    .modal textarea:focus {
      outline: none;
      border-color: #19334a;
      box-shadow: 0 0 0 3px rgba(25,51,74,0.1);
    }
    .modal-actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .bilingual-row { grid-template-columns: 1fr; }
      .tab-nav { padding: 8px 12px 0; }
      .tab-btn { padding: 8px 14px; font-size: 13px; }
      .editor-area { padding: 0 12px; margin: 12px auto; }
      .editor-card { padding: 16px; }
    }
  </style>
</head>
<body>

<!-- Login Screen -->
<div id="login-screen" class="login-screen">
  <h1>STKS Admin</h1>
  <p>Sign in with GitHub to manage site content.</p>
  <button class="login-btn" onclick="startLogin()">
    <svg viewBox="0 0 16 16"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/></svg>
    Login with GitHub
  </button>
  <div id="login-error" class="error-msg" style="display:none"></div>
</div>

<!-- Dashboard -->
<div id="dashboard" class="dashboard">
  <div class="header">
    <div class="header-left">
      <img src="/assets/favicon/favicon.png" alt="STKS" class="header-logo">
      <h1>STKS Admin</h1>
    </div>
    <div class="header-right">
      <span class="username" id="username-display"></span>
      <button class="btn-ghost" onclick="logout()">Logout</button>
    </div>
  </div>

  <div class="tab-nav" id="tab-nav">
    <button class="tab-btn active" data-tab="quadrants">Quadrants</button>
    <button class="tab-btn" data-tab="about">About</button>
    <button class="tab-btn" data-tab="team">Team</button>
    <button class="tab-btn" data-tab="portfolio">Portfolio</button>
    <button class="tab-btn" data-tab="quotes">Quotes</button>
    <button class="tab-btn" data-tab="faq">FAQ</button>
    <button class="tab-btn" data-tab="contact">Contact</button>
  </div>

  <div class="editor-area" id="editor-area"></div>

  <div class="save-bar">
    <span class="save-status" id="save-status">Ready</span>
    <div style="display:flex;gap:8px">
      <button class="btn-outline" onclick="revertChanges()">Revert</button>
      <button class="btn-primary" id="save-btn" onclick="saveCurrentTab()">Save Current Tab</button>
      <button class="btn-deploy" id="deploy-btn" onclick="deployAll()" disabled>Deploy</button>
    </div>
  </div>

  <div id="deploy-modal" class="modal-overlay" style="display:none" onclick="if(event.target===this)hideDeployModal()">
    <div class="modal">
      <h2>Deploy Changes</h2>
      <ul class="change-list" id="deploy-changes"></ul>
      <div class="field-label">Commit message</div>
      <textarea id="deploy-message"></textarea>
      <div class="modal-actions">
        <button class="btn-outline" onclick="hideDeployModal()">Cancel</button>
        <button class="btn-deploy" id="deploy-confirm-btn" onclick="executeDeploy()">Deploy</button>
      </div>
    </div>
  </div>
</div>

<script>
// ─── Config ───────────────────────────────────────────
const REPO_OWNER = 'stkskr';
const REPO_NAME = 'stkjs';
const BRANCH = 'main';
const DATA_PATH = 'src/data';

const FILES = {
  about: { path: `${DATA_PATH}/about.json`, label: 'About' },
  contact: { path: `${DATA_PATH}/contact.json`, label: 'Contact' },
  quadrants: { path: `${DATA_PATH}/quadrants.json`, label: 'Quadrants' },
  portfolio: { path: `${DATA_PATH}/portfolio.json`, label: 'Portfolio' },
  faq: { path: `${DATA_PATH}/faq.json`, label: 'FAQ' },
  quotes: { path: `${DATA_PATH}/quotes.json`, label: 'Quotes' },
  testimonials: { path: `${DATA_PATH}/testimonials.json`, label: 'Testimonials' },
  team: { path: `${DATA_PATH}/team.json`, label: 'Team' },
};

// ─── State ────────────────────────────────────────────
let token = null;
let currentTab = 'about';
let fileCache = {};    // { [tab]: { data, sha } }
let dirtyTabs = {};    // { [tab]: true } if unsaved
let imageManifest = null;
let pendingImageOps = []; // queued image ops: { action, repoPath, base64?, label }
let originalData = {};    // deep copies of data as loaded from GitHub
let originalManifest = null; // snapshot of imageManifest when first loaded

// ─── Auth ─────────────────────────────────────────────
function startLogin() {
  window.location.href = '/api/auth/github';
}

function logout() {
  sessionStorage.removeItem('gh_token');
  token = null;
  fileCache = {};
  document.getElementById('dashboard').classList.remove('visible');
  document.getElementById('login-screen').style.display = '';
}

function initAuth() {
  // Check hash for token or error
  const hash = window.location.hash.substring(1);
  const params = new URLSearchParams(hash);

  if (params.has('error')) {
    const errors = {
      no_code: 'Authentication failed. No authorization code received.',
      token_failed: 'Failed to exchange authorization code for token.',
      unauthorized: 'Your GitHub account is not authorized to access this admin panel.',
      server_error: 'Server error during authentication.',
    };
    const msg = errors[params.get('error')] || 'Unknown error occurred.';
    document.getElementById('login-error').textContent = msg;
    document.getElementById('login-error').style.display = '';
    history.replaceState(null, '', '/admin');
    return;
  }

  if (params.has('token')) {
    token = params.get('token');
    sessionStorage.setItem('gh_token', token);
    history.replaceState(null, '', '/admin');
  } else {
    token = sessionStorage.getItem('gh_token');
  }

  if (token) {
    showDashboard();
  }
}

async function showDashboard() {
  document.getElementById('login-screen').style.display = 'none';
  document.getElementById('dashboard').classList.add('visible');

  // Fetch username
  try {
    const res = await ghFetch('https://api.github.com/user');
    const user = await res.json();
    document.getElementById('username-display').textContent = user.login;
  } catch (e) {
    document.getElementById('username-display').textContent = '';
  }

  // Setup tab listeners
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => switchTab(btn.dataset.tab));
  });

  // Load initial tab
  switchTab('quadrants');
}

// ─── GitHub API ───────────────────────────────────────
function ghFetch(url, options = {}) {
  return fetch(url, {
    ...options,
    headers: {
      Authorization: `Bearer ${token}`,
      Accept: 'application/vnd.github.v3+json',
      ...(options.headers || {}),
    },
  });
}

async function loadFile(tab) {
  if (fileCache[tab]) return fileCache[tab];

  const filePath = FILES[tab].path;
  const url = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${filePath}?ref=${BRANCH}`;

  const res = await ghFetch(url);
  if (!res.ok) throw new Error(`Failed to load ${filePath}: ${res.status}`);

  const fileData = await res.json();
  const content = decodeContent(fileData.content);
  const data = JSON.parse(content);

  fileCache[tab] = { data, sha: fileData.sha };
  originalData[tab] = JSON.parse(JSON.stringify(data));
  return fileCache[tab];
}

async function saveFile(tab) {
  const filePath = FILES[tab].path;
  const url = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${filePath}`;

  const { data, sha } = fileCache[tab];
  const content = encodeContent(JSON.stringify(data, null, 2) + '\n');

  const res = await ghFetch(url, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      message: `Update ${FILES[tab].label.toLowerCase()} content via admin`,
      content,
      sha,
      branch: BRANCH,
    }),
  });

  if (!res.ok) {
    const err = await res.json();
    throw new Error(err.message || `Save failed: ${res.status}`);
  }

  const result = await res.json();
  fileCache[tab].sha = result.content.sha;
  dirtyTabs[tab] = false;
}

// UTF-8 safe base64 encode/decode
function encodeContent(str) {
  return btoa(unescape(encodeURIComponent(str)));
}

function decodeContent(base64) {
  return decodeURIComponent(escape(atob(base64)));
}

// ─── Tab Switching ────────────────────────────────────
async function switchTab(tab) {
  // Save current edits to cache before switching
  if (currentTab && fileCache[currentTab]) {
    collectFormData(currentTab);
  }

  currentTab = tab;

  // Update active tab button
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.tab === tab);
  });

  const area = document.getElementById('editor-area');
  area.innerHTML = '<div style="text-align:center;padding:40px;color:#6b7280">Loading...</div>';

  try {
    await loadFile(tab);
    if (tab === 'portfolio') await loadImageManifest();
    renderEditor(tab);
    updateDirtyIndicators();
    setStatus('Ready');
  } catch (e) {
    area.innerHTML = `<div class="editor-card"><p style="color:#dc2626">Error loading file: ${escapeHtml(e.message)}</p><button class="btn-outline" style="margin-top:12px" onclick="switchTab('${tab}')">Retry</button></div>`;
    setStatus('Error loading file', 'error');
  }
}

// ─── Save & Deploy ────────────────────────────────────
function getDirtyTabs() {
  const dirty = [];
  for (const tab of Object.keys(fileCache)) {
    if (tab === 'testimonials') continue;
    if (!originalData[tab]) continue;
    if (JSON.stringify(fileCache[tab].data) !== JSON.stringify(originalData[tab])) {
      dirty.push(tab);
    }
  }
  return dirty;
}

function updateDirtyIndicators() {
  const dirty = getDirtyTabs();
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.classList.toggle('dirty', dirty.includes(btn.dataset.tab));
  });
  // Update deploy button
  const deployBtn = document.getElementById('deploy-btn');
  if (!deployBtn) return;
  const totalChanges = dirty.length + pendingImageOps.length;
  if (totalChanges > 0) {
    deployBtn.disabled = false;
    deployBtn.textContent = dirty.length > 1 ? `Deploy (${dirty.length} files)` : 'Deploy';
  } else {
    deployBtn.disabled = true;
    deployBtn.textContent = 'Deploy';
  }
}

function saveCurrentTab() {
  if (!currentTab || !fileCache[currentTab]) return;
  collectFormData(currentTab);
  updateDirtyIndicators();
  setStatus('Saved', 'success');
}

function deployAll() {
  if (!currentTab || !fileCache[currentTab]) return;
  collectFormData(currentTab);
  const dirty = getDirtyTabs();
  if (dirty.length === 0 && pendingImageOps.length === 0) {
    setStatus('No changes to deploy', 'error');
    return;
  }
  showDeployModal(dirty);
}

function setStatus(text, type = '') {
  const el = document.getElementById('save-status');
  el.textContent = text;
  el.className = 'save-status' + (type ? ` ${type}` : '');
}

function revertChanges() {
  if (!currentTab || !originalData[currentTab]) return;
  if (!confirm('Revert all unsaved changes? This will undo everything since the last deploy.')) return;

  // Restore data from snapshot
  fileCache[currentTab].data = JSON.parse(JSON.stringify(originalData[currentTab]));

  // Restore image manifest
  if (originalManifest) {
    imageManifest = JSON.parse(JSON.stringify(originalManifest));
  }

  // Clear pending image operations
  pendingImageOps = [];

  // Re-render
  renderEditor(currentTab);
  updateDirtyIndicators();
  setStatus('Reverted to last saved state', 'success');
}

function showDeployModal(dirtyTabs) {
  const changes = [];
  dirtyTabs.forEach(tab => {
    changes.push(`Update ${FILES[tab].label} data`);
  });
  if (dirtyTabs.includes('quotes')) {
    changes.push('Auto-update Testimonials from flagged quotes');
  }
  pendingImageOps.forEach(op => {
    const icon = op.action === 'upload' ? '+' : '\u2212';
    changes.push(`${icon} ${op.label}`);
  });

  document.getElementById('deploy-changes').innerHTML =
    changes.map(c => `<li>${escapeHtml(c)}</li>`).join('');
  const labels = dirtyTabs.map(t => FILES[t].label.toLowerCase()).join(', ');
  document.getElementById('deploy-message').value =
    `Update ${labels} content via admin`;
  document.getElementById('deploy-modal').style.display = '';
}

function hideDeployModal() {
  document.getElementById('deploy-modal').style.display = 'none';
}

async function batchCommit(message, fileOps) {
  // Get current branch head
  const refRes = await ghFetch(
    `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/git/ref/heads/${BRANCH}`
  );
  if (!refRes.ok) throw new Error('Failed to get branch reference');
  const headSha = (await refRes.json()).object.sha;

  // Get tree from head commit
  const commitRes = await ghFetch(
    `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/git/commits/${headSha}`
  );
  if (!commitRes.ok) throw new Error('Failed to get current commit');
  const baseTreeSha = (await commitRes.json()).tree.sha;

  // Create blobs and build tree entries
  const treeItems = [];
  for (const op of fileOps) {
    if (op.deleted) {
      treeItems.push({ path: op.path, mode: '100644', type: 'blob', sha: null });
    } else {
      const blobRes = await ghFetch(
        `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/git/blobs`,
        {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ content: op.content, encoding: op.encoding }),
        }
      );
      if (!blobRes.ok) throw new Error(`Failed to create blob for ${op.path}`);
      const blob = await blobRes.json();
      treeItems.push({ path: op.path, mode: '100644', type: 'blob', sha: blob.sha });
    }
  }

  // Create new tree
  const treeRes = await ghFetch(
    `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/git/trees`,
    {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ base_tree: baseTreeSha, tree: treeItems }),
    }
  );
  if (!treeRes.ok) throw new Error('Failed to create tree');
  const treeSha = (await treeRes.json()).sha;

  // Create commit
  const newCommitRes = await ghFetch(
    `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/git/commits`,
    {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message, tree: treeSha, parents: [headSha] }),
    }
  );
  if (!newCommitRes.ok) throw new Error('Failed to create commit');
  const newCommitSha = (await newCommitRes.json()).sha;

  // Update branch ref (fast-forward only)
  const updateRes = await ghFetch(
    `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/git/refs/heads/${BRANCH}`,
    {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ sha: newCommitSha, force: false }),
    }
  );
  if (!updateRes.ok) throw new Error('Branch updated by someone else. Reload and try again.');
}

async function checkForExternalChanges(dirtyTabs) {
  for (const tab of dirtyTabs) {
    const filePath = FILES[tab].path;
    const url = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${filePath}?ref=${BRANCH}`;
    const res = await ghFetch(url);
    if (!res.ok) continue;

    const remote = await res.json();
    const cachedSha = fileCache[tab]?.sha;
    if (remote.sha === cachedSha) continue;

    // File changed externally — parse remote data to compare
    const remoteData = JSON.parse(decodeContent(remote.content));
    const localData = fileCache[tab].data;

    const info = { tab, remoteSha: remote.sha, remoteData };

    if (Array.isArray(remoteData) && Array.isArray(localData)) {
      const localIds = new Set(localData.map(item => item.id || JSON.stringify(item)));
      info.newItems = remoteData.filter(item => !localIds.has(item.id || JSON.stringify(item)));
      info.remoteCount = remoteData.length;
      info.localCount = localData.length;
    } else if (tab === 'faq') {
      info.remoteCount = remoteData.faqData?.length || 0;
      info.localCount = localData.faqData?.length || 0;
    }

    return info; // return first stale tab found
  }
  return null;
}

async function executeDeploy() {
  const message = document.getElementById('deploy-message').value.trim();
  if (!message) { alert('Please enter a commit message.'); return; }

  hideDeployModal();

  const deployBtn = document.getElementById('deploy-btn');
  deployBtn.disabled = true;
  deployBtn.innerHTML = '<span class="spinner"></span> Checking...';
  setStatus('Checking for external changes...', 'saving');

  try {
    const dirtyTabs = getDirtyTabs();

    // Staleness check — detect if someone else modified any dirty file
    const stale = await checkForExternalChanges(dirtyTabs);
    if (stale) {
      deployBtn.disabled = false;
      updateDirtyIndicators();

      let warning = `The ${FILES[stale.tab].label} file has been modified outside of Admin since you loaded it.\n\n`;
      if (stale.newItems && stale.newItems.length > 0) {
        const names = stale.newItems.map(item =>
          item.title?.en || item.title?.ko || item.name?.en || item.id || '(unknown)'
        ).join(', ');
        warning += `${stale.newItems.length} item(s) added externally: ${names}\n`;
        warning += `Remote has ${stale.remoteCount} items, you have ${stale.localCount}.\n\n`;
      } else if (stale.remoteCount !== undefined) {
        warning += `Remote has ${stale.remoteCount} items, you have ${stale.localCount}.\n\n`;
      }
      warning += 'Choose an option:\n';
      warning += `• OK = Reload ${FILES[stale.tab].label} data (edits to that tab will be lost)\n`;
      warning += '• Cancel = Go back and review before deploying';

      if (confirm(warning)) {
        delete fileCache[stale.tab];
        delete originalData[stale.tab];
        await loadFile(stale.tab);
        if (stale.tab === currentTab) renderEditor(currentTab);
        updateDirtyIndicators();
        setStatus(`Reloaded ${FILES[stale.tab].label} from GitHub`, 'success');
      } else {
        setStatus('Deploy cancelled — review your changes', 'error');
      }
      return;
    }

    deployBtn.innerHTML = '<span class="spinner"></span> Deploying...';
    setStatus('Deploying...', 'saving');

    const fileOps = [];

    // 1. All dirty tabs' JSON data
    for (const tab of dirtyTabs) {
      fileOps.push({
        path: FILES[tab].path,
        content: JSON.stringify(fileCache[tab].data, null, 2) + '\n',
        encoding: 'utf-8',
      });
    }

    // 2. Auto-generated testimonials (when quotes are dirty)
    if (dirtyTabs.includes('quotes')) {
      const testimonials = fileCache.quotes.data
        .filter(q => q.isTestimonial)
        .map(q => ({
          quote: q.quote,
          author: {
            ko: [q.author, q.role.ko].filter(Boolean).join(' '),
            en: [q.author, q.role.en].filter(Boolean).join(' '),
          },
        }));
      fileOps.push({
        path: FILES.testimonials.path,
        content: JSON.stringify(testimonials, null, 2) + '\n',
        encoding: 'utf-8',
      });
    }

    // 3. Pending image operations
    for (const op of pendingImageOps) {
      if (op.action === 'upload') {
        fileOps.push({ path: op.repoPath, content: op.base64, encoding: 'base64' });
      } else if (op.action === 'delete') {
        fileOps.push({ path: op.repoPath, deleted: true });
      }
    }

    await batchCommit(message, fileOps);

    // Clear queue, invalidate and reload all deployed tabs
    pendingImageOps = [];
    for (const tab of dirtyTabs) {
      delete fileCache[tab];
      delete originalData[tab];
    }
    if (dirtyTabs.includes('quotes')) delete fileCache.testimonials;

    // Reload current tab (refreshes SHA + originalData snapshot)
    await loadFile(currentTab);
    renderEditor(currentTab);

    updateDirtyIndicators();
    setStatus('Deployed successfully!', 'success');
  } catch (e) {
    setStatus('Deploy failed: ' + e.message, 'error');
  } finally {
    deployBtn.disabled = false;
    updateDirtyIndicators();
  }
}

// ─── Image Manifest & Upload ─────────────────────────
async function loadImageManifest() {
  if (imageManifest) return imageManifest;
  try {
    const url = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${DATA_PATH}/image-manifest.json?ref=${BRANCH}`;
    const res = await ghFetch(url);
    if (!res.ok) { imageManifest = {}; return imageManifest; }
    const fileData = await res.json();
    imageManifest = JSON.parse(decodeContent(fileData.content));
  } catch (e) {
    imageManifest = {};
  }
  if (!originalManifest) originalManifest = JSON.parse(JSON.stringify(imageManifest));
  return imageManifest;
}

function readFileAsBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result.split(',')[1]);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

async function getFileSha(repoPath) {
  try {
    const url = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${repoPath}?ref=${BRANCH}`;
    const res = await ghFetch(url);
    if (!res.ok) return null;
    const data = await res.json();
    return data.sha;
  } catch (e) {
    return null;
  }
}

async function uploadGhFile(repoPath, base64Content, sha, message) {
  const url = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${repoPath}`;
  const body = { message, content: base64Content, branch: BRANCH };
  if (sha) body.sha = sha;
  const res = await ghFetch(url, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(body),
  });
  if (!res.ok) {
    const err = await res.json();
    throw new Error(err.message || `Upload failed: ${res.status}`);
  }
  return await res.json();
}

async function deleteGhFile(repoPath, sha, message) {
  const url = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${repoPath}`;
  const res = await ghFetch(url, {
    method: 'DELETE',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ message, sha, branch: BRANCH }),
  });
  if (!res.ok) {
    const err = await res.json();
    throw new Error(err.message || `Delete failed: ${res.status}`);
  }
}

function getPortfolioPrefix(i) {
  const slug = getVal(`pf-${i}-id`);
  if (!slug || !imageManifest) return String(i + 1).padStart(2, '0');
  const entry = imageManifest[slug];
  if (entry?.thumbnail) {
    const filename = entry.thumbnail.split('/').pop();
    const match = filename.match(/^(\d+)_/);
    if (match) return match[1];
  }
  return String(i + 1).padStart(2, '0');
}

function getNextSliderNum(slug) {
  const entry = (imageManifest || {})[slug];
  if (!entry || !entry.slider || entry.slider.length === 0) return 0;
  let maxNum = 0;
  entry.slider.forEach(path => {
    const match = path.match(/_(\d{2})\.\w+$/);
    if (match) maxNum = Math.max(maxNum, parseInt(match[1], 10));
  });
  return maxNum || entry.slider.length;
}

function renderPortfolioImages(item, i) {
  const slug = item.id || '';
  const manifest = imageManifest || {};
  const entry = manifest[slug] || { thumbnail: '', slider: [] };

  let thumbHtml;
  if (entry.thumbnail) {
    thumbHtml = `<div class="image-preview-item"><img src="${escapeAttr(entry.thumbnail)}" alt="Thumbnail" onerror="this.parentElement.innerHTML='<span style=\\'font-size:11px;color:#999;padding:4px\\'>Not found</span>'"></div>`;
  } else {
    thumbHtml = '<span style="font-size:12px;color:#9ca3af">No thumbnail</span>';
  }

  let sliderHtml;
  if (entry.slider && entry.slider.length > 0) {
    sliderHtml = entry.slider.map((path, si) =>
      `<div class="image-preview-item">
        <img src="${escapeAttr(path)}" alt="Slide ${si+1}" onerror="this.parentElement.innerHTML='<span style=\\'font-size:11px;color:#999;padding:4px\\'>Not found</span>'">
        <button class="remove-img" title="Delete" onclick="event.stopPropagation();deleteSliderImage(${i},'${escapeAttr(slug)}',${si})">&#215;</button>
      </div>`
    ).join('');
  } else {
    sliderHtml = '<span style="font-size:12px;color:#9ca3af">No slider images</span>';
  }

  return `
    <div class="image-preview-section">
      <h4>Thumbnail</h4>
      <div class="image-preview-grid" id="pf-${i}-thumb-preview">${thumbHtml}</div>
      <input type="file" id="pf-${i}-thumb-file" accept="image/*" style="display:none" onchange="uploadThumbnail(${i})">
      <button class="upload-btn" type="button" onclick="document.getElementById('pf-${i}-thumb-file').click()">&#128247; Upload Thumbnail</button>
      <div class="upload-status" id="pf-${i}-thumb-status"></div>

      <h4 style="margin-top:16px">Slider Images (${(entry.slider || []).length})</h4>
      <div class="image-preview-grid" id="pf-${i}-slider-preview">${sliderHtml}</div>
      <input type="file" id="pf-${i}-slider-file" accept="image/*" multiple style="display:none" onchange="uploadSliderImages(${i})">
      <button class="upload-btn" type="button" onclick="document.getElementById('pf-${i}-slider-file').click()">&#128247; Upload Slider Images</button>
      <div class="upload-status" id="pf-${i}-slider-status"></div>
    </div>
  `;
}

async function uploadThumbnail(i) {
  const fileInput = document.getElementById(`pf-${i}-thumb-file`);
  const file = fileInput.files[0];
  if (!file) return;

  const slug = getVal(`pf-${i}-id`);
  if (!slug) { alert('Please set an ID (URL slug) before uploading images.'); return; }

  const prefix = getPortfolioPrefix(i);
  const ext = file.name.split('.').pop().toLowerCase();
  const filename = `${prefix}_${slug}.${ext}`;
  const repoPath = `public/assets/portfolio/thumbnails/${filename}`;

  const statusEl = document.getElementById(`pf-${i}-thumb-status`);

  try {
    const base64 = await readFileAsBase64(file);

    // If existing thumbnail has a different filename, queue old one for deletion
    const entry = (imageManifest || {})[slug];
    if (entry?.thumbnail) {
      const oldFilename = entry.thumbnail.split('/').pop();
      if (oldFilename !== filename) {
        pendingImageOps.push({
          action: 'delete',
          repoPath: `public/assets/portfolio/thumbnails/${oldFilename}`,
          label: `old thumbnail for ${slug}`,
        });
      }
    }

    // Remove any previous queued thumbnail for this slug, then queue new one
    pendingImageOps = pendingImageOps.filter(op =>
      !(op.action === 'upload' && op.repoPath === repoPath)
    );
    pendingImageOps.push({ action: 'upload', repoPath, base64, label: `thumbnail for ${slug}` });

    // Update manifest cache
    if (!imageManifest[slug]) imageManifest[slug] = { thumbnail: '', slider: [] };
    imageManifest[slug].thumbnail = `/assets/portfolio/thumbnails/${filename}`;

    // Show immediate preview using object URL
    const objectUrl = URL.createObjectURL(file);
    document.getElementById(`pf-${i}-thumb-preview`).innerHTML =
      `<div class="image-preview-item"><img src="${objectUrl}" alt="Thumbnail"></div>`;

    statusEl.textContent = 'Queued. Click Save & Deploy to commit.';
    statusEl.className = 'upload-status uploaded';
    updateDirtyIndicators();
  } catch (e) {
    statusEl.textContent = 'Failed to read file: ' + e.message;
    statusEl.className = 'upload-status upload-error';
  }
  fileInput.value = '';
}

async function uploadSliderImages(i) {
  const fileInput = document.getElementById(`pf-${i}-slider-file`);
  const files = Array.from(fileInput.files);
  if (!files.length) return;

  const slug = getVal(`pf-${i}-id`);
  if (!slug) { alert('Please set an ID (URL slug) before uploading images.'); return; }

  const prefix = getPortfolioPrefix(i);
  let nextNum = getNextSliderNum(slug);

  const statusEl = document.getElementById(`pf-${i}-slider-status`);
  const previewContainer = document.getElementById(`pf-${i}-slider-preview`);

  // Clear "No slider images" placeholder
  if (previewContainer.querySelector('span:not(.remove-img)')) {
    previewContainer.innerHTML = '';
  }

  try {
    for (let f = 0; f < files.length; f++) {
      const file = files[f];
      const ext = file.name.split('.').pop().toLowerCase();
      const num = String(nextNum + f + 1).padStart(2, '0');
      const filename = `${prefix}_${slug}_${num}.${ext}`;
      const repoPath = `public/assets/portfolio/slider/${filename}`;

      const base64 = await readFileAsBase64(file);
      pendingImageOps.push({ action: 'upload', repoPath, base64, label: `slider image ${filename}` });

      // Update manifest cache
      if (!imageManifest[slug]) imageManifest[slug] = { thumbnail: '', slider: [] };
      imageManifest[slug].slider.push(`/assets/portfolio/slider/${filename}`);

      // Show preview immediately
      const objectUrl = URL.createObjectURL(file);
      const div = document.createElement('div');
      div.className = 'image-preview-item';
      div.innerHTML = `<img src="${objectUrl}" alt="Slider">`;
      previewContainer.appendChild(div);
    }

    statusEl.textContent = `${files.length} image${files.length > 1 ? 's' : ''} queued. Click Save & Deploy to commit.`;
    statusEl.className = 'upload-status uploaded';
    updateDirtyIndicators();
  } catch (e) {
    statusEl.textContent = 'Failed to read files: ' + e.message;
    statusEl.className = 'upload-status upload-error';
  }
  fileInput.value = '';
}

function deleteSliderImage(i, slug, sliderIndex) {
  if (!confirm('Mark this slider image for deletion?')) return;

  const entry = (imageManifest || {})[slug];
  if (!entry || !entry.slider[sliderIndex]) return;

  const path = entry.slider[sliderIndex];
  const filename = path.split('/').pop();

  // Queue the deletion
  pendingImageOps.push({
    action: 'delete',
    repoPath: `public/assets/portfolio/slider/${filename}`,
    label: `slider image ${filename}`,
  });

  // Update manifest cache and refresh preview
  entry.slider.splice(sliderIndex, 1);
  const previewContainer = document.getElementById(`pf-${i}-slider-preview`);
  if (entry.slider.length === 0) {
    previewContainer.innerHTML = '<span style="font-size:12px;color:#9ca3af">No slider images</span>';
  } else {
    previewContainer.innerHTML = entry.slider.map((p, si) =>
      `<div class="image-preview-item">
        <img src="${escapeAttr(p)}" alt="Slide ${si+1}" onerror="this.parentElement.innerHTML='<span style=\\'font-size:11px;color:#999;padding:4px\\'>Not found</span>'">
        <button class="remove-img" title="Delete" onclick="event.stopPropagation();deleteSliderImage(${i},'${escapeAttr(slug)}',${si})">&#215;</button>
      </div>`
    ).join('');
  }

  const statusEl = document.getElementById(`pf-${i}-slider-status`);
  statusEl.textContent = 'Marked for deletion. Will apply on Save & Deploy.';
  statusEl.className = 'upload-status uploading';
  updateDirtyIndicators();
}

// ─── Drag & Drop Reordering ──────────────────────────
let dragState = { tab: null, fromIndex: null, insertAfter: false };

function getDragArray(tab) {
  if (tab === 'faq') return fileCache.faq.data.faqData;
  return fileCache[tab].data;
}

function handleDragStart(e, tab, index) {
  dragState = { tab, fromIndex: index, insertAfter: false };
  e.dataTransfer.effectAllowed = 'move';
  e.dataTransfer.setData('text/plain', String(index));
  requestAnimationFrame(() => {
    e.target.closest('[data-drag-item]').classList.add('dragging');
  });
}

function handleDragOver(e) {
  if (dragState.tab === null) return;
  e.preventDefault();
  e.dataTransfer.dropEffect = 'move';

  document.querySelectorAll('.drag-over-top, .drag-over-bottom').forEach(el => {
    el.classList.remove('drag-over-top', 'drag-over-bottom');
  });

  const item = e.target.closest('[data-drag-item]');
  if (item && !item.classList.contains('dragging')) {
    const rect = item.getBoundingClientRect();
    const midY = rect.top + rect.height / 2;
    if (e.clientY < midY) {
      item.classList.add('drag-over-top');
      dragState.insertAfter = false;
    } else {
      item.classList.add('drag-over-bottom');
      dragState.insertAfter = true;
    }
  }
}

function handleDrop(e, tab, toIndex) {
  e.preventDefault();
  if (dragState.tab !== tab || dragState.fromIndex === null) return;

  const fromIndex = dragState.fromIndex;
  if (fromIndex === toIndex) return;

  collectFormData(tab);
  const arr = getDragArray(tab);
  const [item] = arr.splice(fromIndex, 1);

  let insertAt = toIndex;
  if (dragState.insertAfter) insertAt++;
  if (fromIndex < insertAt) insertAt--;

  arr.splice(insertAt, 0, item);
  renderEditor(tab);
}

function handleDragEnd(e) {
  document.querySelectorAll('.dragging').forEach(el => el.classList.remove('dragging'));
  document.querySelectorAll('.drag-over-top, .drag-over-bottom').forEach(el => {
    el.classList.remove('drag-over-top', 'drag-over-bottom');
  });
  dragState = { tab: null, fromIndex: null, insertAfter: false };
}

// ─── Team Sub-item Drag (Edu/Exp) ────────────────────
function handleTeamSubDragStart(e, type, memberIdx, itemIdx) {
  dragState = { tab: `team-${type}-${memberIdx}`, fromIndex: itemIdx, insertAfter: false };
  e.dataTransfer.effectAllowed = 'move';
  e.dataTransfer.setData('text/plain', String(itemIdx));
  requestAnimationFrame(() => {
    e.target.closest('[data-drag-item]').classList.add('dragging');
  });
}

function handleTeamSubDrop(e, type, memberIdx, toIndex) {
  e.preventDefault();
  const expectedTab = `team-${type}-${memberIdx}`;
  if (dragState.tab !== expectedTab || dragState.fromIndex === null) return;

  const fromIndex = dragState.fromIndex;
  if (fromIndex === toIndex) return;

  collectFormData('team');
  const member = fileCache.team.data[memberIdx];
  const field = type === 'edu' ? 'education' : 'experience';

  // Move in both ko and en arrays together
  const koArr = member[field].ko;
  const enArr = member[field].en;

  let insertAt = toIndex;
  if (dragState.insertAfter) insertAt++;
  if (fromIndex < insertAt) insertAt--;

  const [koItem] = koArr.splice(fromIndex, 1);
  koArr.splice(insertAt, 0, koItem);
  const [enItem] = enArr.splice(fromIndex, 1);
  enArr.splice(insertAt, 0, enItem);

  renderEditor('team');
}

// ─── Renderers ────────────────────────────────────────
function renderEditor(tab) {
  const area = document.getElementById('editor-area');
  const { data } = fileCache[tab];

  switch (tab) {
    case 'about': area.innerHTML = renderAboutEditor(data); break;
    case 'contact': area.innerHTML = renderContactEditor(data); break;
    case 'quadrants': area.innerHTML = renderQuadrantsEditor(data); break;
    case 'portfolio': area.innerHTML = renderPortfolioEditor(data); break;
    case 'faq': area.innerHTML = renderFaqEditor(data); break;
    case 'quotes': area.innerHTML = renderQuotesEditor(data); break;
    case 'team': area.innerHTML = renderTeamEditor(data); break;
  }
  // After rendering portfolio, bind search and toggle listeners
  if (tab === 'portfolio') bindPortfolioListeners();
}

// About editor
function renderAboutEditor(data) {
  return `
    <div class="editor-card">
      <h3>Title &amp; Subtitle</h3>
      ${bilingualField('about-title', 'Title', data.title)}
      ${bilingualTextarea('about-subtitle', 'Subtitle', data.subtitle, true)}
    </div>
    <div class="editor-card">
      <h3>Video</h3>
      <div class="single-field">
        <div class="field-group">
          <label>YouTube Embed URL</label>
          <input type="text" data-field="about-video-url" value="${escapeAttr(data.video.url)}">
        </div>
      </div>
      ${bilingualField('about-video-title', 'Video Title', data.video.title)}
    </div>
    <div class="editor-card">
      <h3>Download Button</h3>
      ${bilingualField('about-download', 'Button Text', data.downloadButton)}
    </div>
    <div class="editor-card">
      <h3>Section Headings</h3>
      ${bilingualField('about-heading-team', 'Team Heading', data.sectionHeadings.team)}
      ${bilingualField('about-heading-clients-say', 'Clients Say Heading', data.sectionHeadings.clientsSay)}
      ${bilingualField('about-heading-our-clients', 'Our Clients Heading', data.sectionHeadings.ourClients)}
      ${bilingualField('about-heading-our-space', 'Our Space Heading', data.sectionHeadings.ourSpace)}
    </div>
    <div class="editor-card">
      <h3>Call to Action</h3>
      ${bilingualField('about-cta-heading', 'CTA Heading', data.cta.heading)}
      ${bilingualField('about-cta-button', 'CTA Button', data.cta.button)}
    </div>
  `;
}

// Contact editor
function renderContactEditor(data) {
  return `
    <div class="editor-card">
      <h3>Heading</h3>
      ${bilingualField('contact-heading', 'Heading', data.heading)}
    </div>
    <div class="editor-card">
      <h3>Phone</h3>
      ${bilingualField('contact-phone-label', 'Label', data.phone.label)}
      <div class="single-field">
        <div class="field-group">
          <label>Number</label>
          <input type="text" data-field="contact-phone-number" value="${escapeAttr(data.phone.number)}">
        </div>
      </div>
    </div>
    <div class="editor-card">
      <h3>Email</h3>
      ${bilingualField('contact-email-label', 'Label', data.email.label)}
      <div class="single-field">
        <div class="field-group">
          <label>Address</label>
          <input type="text" data-field="contact-email-address" value="${escapeAttr(data.email.address)}">
        </div>
      </div>
    </div>
    <div class="editor-card">
      <h3>Office</h3>
      ${bilingualField('contact-office-label', 'Label', data.office.label)}
      ${bilingualTextarea('contact-office-address', 'Address', data.office.address, true)}
      ${bilingualField('contact-office-plain', 'Address (plain text)', data.office.addressPlain)}
    </div>
    <div class="editor-card">
      <h3>Tagline</h3>
      ${bilingualTextarea('contact-tagline', 'Tagline', data.tagline, true)}
    </div>
    <div class="editor-card">
      <h3>Company Info</h3>
      ${bilingualTextarea('contact-company', 'Company Info', data.companyInfo, true)}
    </div>
    <div class="editor-card">
      <h3>Map</h3>
      <div class="single-field">
        <div class="field-group">
          <label>Google Maps Query</label>
          <input type="text" data-field="contact-map-query" value="${escapeAttr(data.map.query)}">
        </div>
      </div>
    </div>
  `;
}

// FAQ editor
function renderFaqEditor(data) {
  let html = `
    <div class="editor-card">
      <h3>Category Labels</h3>
      ${Object.keys(data.faqCategoryLabels).map(cat =>
        bilingualField(`faq-cat-${cat}`, cat.charAt(0).toUpperCase() + cat.slice(1), data.faqCategoryLabels[cat])
      ).join('')}
    </div>
    <div class="editor-card">
      <h3>FAQ Items</h3>
      <div id="faq-items">
  `;

  data.faqData.forEach((item, i) => {
    html += renderFaqItem(item, i);
  });

  html += `
      </div>
      <div class="array-controls">
        <button class="btn-outline btn-small" onclick="addFaqItem()">+ Add FAQ Item</button>
      </div>
    </div>
  `;
  return html;
}

function renderFaqItem(item, i) {
  const categories = ['services', 'pricing', 'process', 'legal', 'other'];
  return `
    <div class="array-item" data-index="${i}" data-drag-item draggable="true" ondragstart="handleDragStart(event,'faq',${i})" ondragover="handleDragOver(event)" ondrop="handleDrop(event,'faq',${i})" ondragend="handleDragEnd(event)">
      <div class="array-item-header">
        <div style="display:flex;align-items:center;gap:8px">
          <span class="drag-handle" title="Drag to reorder">&#x2807;</span>
          <span class="item-number">FAQ #${i + 1}</span>
        </div>
        <div class="array-item-actions">
          <button class="btn-danger btn-small" onclick="removeFaqItem(${i})">Delete</button>
        </div>
      </div>
      <div class="single-field">
        <div class="field-group">
          <label>Category</label>
          <select data-field="faq-item-${i}-category">
            ${categories.map(c => `<option value="${c}" ${item.category === c ? 'selected' : ''}>${c}</option>`).join('')}
          </select>
        </div>
      </div>
      ${bilingualTextarea(`faq-item-${i}-q`, 'Question', item.question)}
      ${bilingualTextarea(`faq-item-${i}-a`, 'Answer', item.answer)}
    </div>
  `;
}

// Quotes editor (also manages testimonials via checkbox)
function renderQuotesEditor(data) {
  let html = `<div class="editor-card"><h3>Quotes &amp; Testimonials</h3>
    <p style="font-size:13px;color:#6b7280;margin-bottom:16px">Check "Carousel" to feature a quote in the rotating carousel on the homepage.</p>
    <div id="quotes-items">`;
  data.forEach((item, i) => {
    html += renderQuoteItem(item, i);
  });
  html += `</div><div class="array-controls"><button class="btn-outline btn-small" onclick="addQuoteItem()">+ Add Quote</button></div></div>`;
  return html;
}

function renderQuoteItem(item, i) {
  return `
    <div class="array-item" data-index="${i}" data-drag-item draggable="true" ondragstart="handleDragStart(event,'quotes',${i})" ondragover="handleDragOver(event)" ondrop="handleDrop(event,'quotes',${i})" ondragend="handleDragEnd(event)">
      <div class="array-item-header">
        <div style="display:flex;align-items:center;gap:8px">
          <span class="drag-handle" title="Drag to reorder">&#x2807;</span>
          <span class="item-number">Quote #${i + 1}</span>
        </div>
        <div class="array-item-actions">
          <label style="display:flex;align-items:center;gap:4px;font-size:12px;font-weight:600;color:#6b7280;cursor:pointer;margin-right:8px">
            <input type="checkbox" data-field="quote-${i}-testimonial" ${item.isTestimonial ? 'checked' : ''} style="accent-color:#19334a"> Carousel
          </label>
          <button class="btn-danger btn-small" onclick="removeQuoteItem(${i})">Delete</button>
        </div>
      </div>
      ${bilingualTextarea(`quote-${i}-text`, 'Quote', item.quote)}
      <div class="single-field">
        <div class="field-group">
          <label>Author (company)</label>
          <input type="text" data-field="quote-${i}-author" value="${escapeAttr(item.author)}">
        </div>
      </div>
      ${bilingualField(`quote-${i}-role`, 'Role / Name', item.role)}
    </div>
  `;
}

// Team editor
function renderTeamEditor(data) {
  let html = `<div class="editor-card"><h3>Team Members</h3><div id="team-items">`;
  data.forEach((member, i) => {
    html += renderTeamItem(member, i);
  });
  html += `</div><div class="array-controls"><button class="btn-outline btn-small" onclick="addTeamItem()">+ Add Team Member</button></div></div>`;
  return html;
}

function renderTeamItem(member, i) {
  const photoSrc = member.image || '';
  const initial = escapeHtml(member.initial || '');
  const diamondPhoto = photoSrc
    ? `<div class="team-diamond">
        <div class="team-diamond-initial" id="team-${i}-initial-preview">${initial}</div>
        <div class="team-diamond-shape">
          <img src="${escapeAttr(photoSrc)}" alt="Photo" onerror="this.style.display='none'">
        </div>
      </div>`
    : `<div class="team-photo-placeholder"><span>No photo</span></div>`;

  return `
    <div class="array-item" data-index="${i}">
      <div class="array-item-header">
        <span class="item-number">Member #${i + 1}: ${escapeHtml(member.name.en || member.name.ko || '')}</span>
        <div class="array-item-actions">
          ${i > 0 ? `<button class="btn-outline btn-small" onclick="moveTeamItem(${i},-1)">Move Up</button>` : ''}
          <button class="btn-danger btn-small" onclick="removeTeamItem(${i})">Delete Member</button>
        </div>
      </div>

      <div class="team-profile-header">
        <div class="team-photo-wrapper">
          <div id="team-${i}-photo-preview">${diamondPhoto}</div>
          <input type="file" id="team-${i}-photo-file" accept="image/*" style="display:none" onchange="uploadTeamPhoto(${i})">
          <span class="team-photo-upload-btn" onclick="document.getElementById('team-${i}-photo-file').click()">Change photo</span>
          <input type="hidden" data-field="team-${i}-image" value="${escapeAttr(photoSrc)}">
        </div>
        <div class="team-header-fields">
          <div class="team-initial-field">
            <label>Initial</label>
            <input type="text" data-field="team-${i}-initial" value="${escapeAttr(member.initial)}" maxlength="2" oninput="const el=document.getElementById('team-${i}-initial-preview');if(el)el.textContent=this.value">
          </div>
          ${bilingualField(`team-${i}-name`, 'Name', member.name)}
          ${bilingualField(`team-${i}-role`, 'Role', member.role)}
        </div>
      </div>

      <div class="team-section">
        <div class="team-section-header">
          <h4>Education</h4>
          <button class="btn-outline btn-small" onclick="addTeamEdu(${i})">+ Add</button>
        </div>
        <div id="team-${i}-edu">
          ${renderTeamEduItems(member.education, i)}
        </div>
      </div>

      <div class="team-section">
        <div class="team-section-header">
          <h4>Experience</h4>
          <button class="btn-outline btn-small" onclick="addTeamExp(${i})">+ Add</button>
        </div>
        <div id="team-${i}-exp">
          ${renderTeamExpItems(member.experience, i)}
        </div>
      </div>
    </div>
  `;
}

function renderTeamEduItems(education, memberIdx) {
  let html = '';
  const koEdu = education.ko || [];
  const enEdu = education.en || [];
  const count = Math.max(koEdu.length, enEdu.length);
  for (let j = 0; j < count; j++) {
    const koSchool = koEdu[j]?.school || '';
    const enSchool = enEdu[j]?.school || '';
    const koDegree = koEdu[j]?.degree || '';
    const enDegree = enEdu[j]?.degree || '';
    html += `
      <div class="array-item" data-drag-item draggable="true" ondragstart="handleTeamSubDragStart(event,'edu',${memberIdx},${j})" ondragover="handleDragOver(event)" ondrop="handleTeamSubDrop(event,'edu',${memberIdx},${j})" ondragend="handleDragEnd(event)">
        <div class="team-edu-row">
          <div style="display:flex;align-items:center;gap:6px">
            <span class="drag-handle" title="Drag to reorder">&#x2807;</span>
            <span>#${j+1}</span>
          </div>
          <button class="btn-danger btn-small" onclick="removeTeamEdu(${memberIdx},${j})" style="padding:2px 8px;font-size:11px">Remove</button>
        </div>
        <div class="bilingual-row" style="margin-bottom:6px">
          <div class="field-group" style="margin-bottom:0">
            <label><span class="lang-badge ko">KO</span> School</label>
            <input type="text" data-field="team-${memberIdx}-edu-${j}-ko-school" value="${escapeAttr(koSchool)}">
          </div>
          <div class="field-group" style="margin-bottom:0">
            <label><span class="lang-badge en">EN</span> School</label>
            <input type="text" data-field="team-${memberIdx}-edu-${j}-en-school" value="${escapeAttr(enSchool)}">
          </div>
        </div>
        <div class="bilingual-row">
          <div class="field-group" style="margin-bottom:0">
            <label><span class="lang-badge ko">KO</span> Degree</label>
            <input type="text" data-field="team-${memberIdx}-edu-${j}-ko-degree" value="${escapeAttr(koDegree)}">
          </div>
          <div class="field-group" style="margin-bottom:0">
            <label><span class="lang-badge en">EN</span> Degree</label>
            <input type="text" data-field="team-${memberIdx}-edu-${j}-en-degree" value="${escapeAttr(enDegree)}">
          </div>
        </div>
      </div>
    `;
  }
  return html;
}

function renderTeamExpItems(experience, memberIdx) {
  let html = '';
  const koExp = experience.ko || [];
  const enExp = experience.en || [];
  const count = Math.max(koExp.length, enExp.length);
  for (let j = 0; j < count; j++) {
    html += `
      <div class="array-item" data-drag-item draggable="true" ondragstart="handleTeamSubDragStart(event,'exp',${memberIdx},${j})" ondragover="handleDragOver(event)" ondrop="handleTeamSubDrop(event,'exp',${memberIdx},${j})" ondragend="handleDragEnd(event)">
        <div class="team-edu-row">
          <div style="display:flex;align-items:center;gap:6px">
            <span class="drag-handle" title="Drag to reorder">&#x2807;</span>
            <span>#${j+1}</span>
          </div>
          <button class="btn-danger btn-small" onclick="removeTeamExp(${memberIdx},${j})" style="padding:2px 8px;font-size:11px">Remove</button>
        </div>
        <div class="bilingual-row">
          <div class="field-group" style="margin-bottom:0">
            <label><span class="lang-badge ko">KO</span></label>
            <input type="text" data-field="team-${memberIdx}-exp-${j}-ko" value="${escapeAttr(koExp[j] || '')}">
          </div>
          <div class="field-group" style="margin-bottom:0">
            <label><span class="lang-badge en">EN</span></label>
            <input type="text" data-field="team-${memberIdx}-exp-${j}-en" value="${escapeAttr(enExp[j] || '')}">
          </div>
        </div>
      </div>
    `;
  }
  return html;
}

// ─── Data Collection ──────────────────────────────────
function collectFormData(tab) {
  const { data } = fileCache[tab];
  switch (tab) {
    case 'about': collectAbout(data); break;
    case 'contact': collectContact(data); break;
    case 'quadrants': collectQuadrants(data); break;
    case 'portfolio': collectPortfolio(data); break;
    case 'faq': collectFaq(data); break;
    case 'quotes': collectQuotes(data); break;
    case 'team': collectTeam(data); break;
  }
}

function getVal(field) {
  const el = document.querySelector(`[data-field="${field}"]`);
  return el ? el.value : '';
}

function getMediaType(i) {
  const group = document.querySelector(`[data-field="pf-${i}-mediaType"]`);
  if (!group) return '';
  return Array.from(group.querySelectorAll('input[type="checkbox"]:checked'))
    .map(cb => cb.value).join(', ');
}

function getBilingual(prefix) {
  return { ko: getVal(`${prefix}-ko`), en: getVal(`${prefix}-en`) };
}

// For HTML fields: collect textarea newlines back to <br>
function getBilingualHtml(prefix) {
  return {
    ko: getVal(`${prefix}-ko`).replace(/\n/g, '<br>'),
    en: getVal(`${prefix}-en`).replace(/\n/g, '<br>'),
  };
}

function collectAbout(data) {
  data.title = getBilingual('about-title');
  data.subtitle = getBilingualHtml('about-subtitle');
  data.video.url = getVal('about-video-url');
  data.video.title = getBilingual('about-video-title');
  data.downloadButton = getBilingual('about-download');
  data.sectionHeadings.team = getBilingual('about-heading-team');
  data.sectionHeadings.clientsSay = getBilingual('about-heading-clients-say');
  data.sectionHeadings.ourClients = getBilingual('about-heading-our-clients');
  data.sectionHeadings.ourSpace = getBilingual('about-heading-our-space');
  data.cta.heading = getBilingual('about-cta-heading');
  data.cta.button = getBilingual('about-cta-button');
}

function collectContact(data) {
  data.heading = getBilingual('contact-heading');
  data.phone.label = getBilingual('contact-phone-label');
  data.phone.number = getVal('contact-phone-number');
  data.email.label = getBilingual('contact-email-label');
  data.email.address = getVal('contact-email-address');
  data.office.label = getBilingual('contact-office-label');
  data.office.address = getBilingualHtml('contact-office-address');
  data.office.addressPlain = getBilingual('contact-office-plain');
  data.tagline = getBilingualHtml('contact-tagline');
  data.companyInfo = getBilingualHtml('contact-company');
  data.map.query = getVal('contact-map-query');
}

function collectFaq(data) {
  // Category labels
  Object.keys(data.faqCategoryLabels).forEach(cat => {
    data.faqCategoryLabels[cat] = getBilingual(`faq-cat-${cat}`);
  });

  // FAQ items
  const items = document.querySelectorAll('#faq-items > .array-item');
  data.faqData = Array.from(items).map((el, i) => ({
    category: getVal(`faq-item-${i}-category`),
    question: getBilingual(`faq-item-${i}-q`),
    answer: getBilingual(`faq-item-${i}-a`),
  }));
}

function collectQuotes(data) {
  const items = document.querySelectorAll('#quotes-items > .array-item');
  const result = Array.from(items).map((el, i) => {
    const cb = document.querySelector(`[data-field="quote-${i}-testimonial"]`);
    const obj = {
      quote: getBilingual(`quote-${i}-text`),
      author: getVal(`quote-${i}-author`),
      role: getBilingual(`quote-${i}-role`),
    };
    if (cb && cb.checked) obj.isTestimonial = true;
    return obj;
  });
  fileCache.quotes.data = result;
}

function collectTeam(data) {
  const items = document.querySelectorAll('#team-items > .array-item');
  const result = Array.from(items).map((el, i) => {
    // Education
    const eduContainer = document.getElementById(`team-${i}-edu`);
    const eduItems = eduContainer ? eduContainer.querySelectorAll('.array-item') : [];
    const koEdu = [];
    const enEdu = [];
    eduItems.forEach((_, j) => {
      koEdu.push({ school: getVal(`team-${i}-edu-${j}-ko-school`), degree: getVal(`team-${i}-edu-${j}-ko-degree`) });
      enEdu.push({ school: getVal(`team-${i}-edu-${j}-en-school`), degree: getVal(`team-${i}-edu-${j}-en-degree`) });
    });

    // Experience
    const expContainer = document.getElementById(`team-${i}-exp`);
    const expItems = expContainer ? expContainer.querySelectorAll('.array-item') : [];
    const koExp = [];
    const enExp = [];
    expItems.forEach((_, j) => {
      koExp.push(getVal(`team-${i}-exp-${j}-ko`));
      enExp.push(getVal(`team-${i}-exp-${j}-en`));
    });

    return {
      name: getBilingual(`team-${i}-name`),
      initial: getVal(`team-${i}-initial`),
      role: getBilingual(`team-${i}-role`),
      image: getVal(`team-${i}-image`),
      education: { ko: koEdu, en: enEdu },
      experience: { ko: koExp, en: enExp },
    };
  });
  fileCache.team.data = result;
}

// Quadrants editor
function renderQuadrantsEditor(data) {
  const sections = ['about', 'services', 'portfolio', 'clients'];
  return sections.map(section => `
    <div class="editor-card">
      <h3>${section.charAt(0).toUpperCase() + section.slice(1)} Quadrant</h3>
      ${bilingualTextarea(`quad-${section}`, 'Heading lines (one per line)', {
        ko: (data[section]?.ko || []).join('\n'),
        en: (data[section]?.en || []).join('\n')
      })}
    </div>
  `).join('');
}

function collectQuadrants(data) {
  ['about', 'services', 'portfolio', 'clients'].forEach(section => {
    const ko = getVal(`quad-${section}-ko`);
    const en = getVal(`quad-${section}-en`);
    data[section] = {
      ko: ko.split('\n'),
      en: en.split('\n'),
    };
  });
}

// Portfolio editor
function renderPortfolioEditor(data) {
  let html = `
    <div class="editor-card">
      <h3>Portfolio Items (${data.length})</h3>
      <div class="search-bar">
        <input type="text" id="portfolio-search" placeholder="Search by title, client, or media type...">
        <span class="result-count" id="portfolio-count">${data.length} items</span>
      </div>
      <div id="portfolio-items">
  `;
  data.forEach((item, i) => {
    html += renderPortfolioItem(item, i);
  });
  html += `
      </div>
      <div class="array-controls">
        <button class="btn-outline btn-small" onclick="addPortfolioItem()">+ Add Portfolio Item</button>
      </div>
    </div>
  `;
  return html;
}

const MEDIA_TYPES = ['video', 'online', 'branding', 'sns', 'ooh', 'script'];

function renderMediaTypeCheckboxes(i, currentValue) {
  const selected = currentValue.split(',').map(s => s.trim().toLowerCase()).filter(Boolean);
  return `<div class="media-type-group" data-field="pf-${i}-mediaType">` +
    MEDIA_TYPES.map(type =>
      `<label><input type="checkbox" value="${type}" ${selected.includes(type) ? 'checked' : ''}><span>${type}</span></label>`
    ).join('') + '</div>';
}

function renderPortfolioItem(item, i) {
  const title = item.title?.en || item.title?.ko || '(untitled)';
  return `
    <div class="portfolio-item" data-index="${i}" data-search="${escapeAttr((title + ' ' + (item.client||'') + ' ' + (item.mediaType||'')).toLowerCase())}" data-drag-item draggable="true" ondragstart="handleDragStart(event,'portfolio',${i})" ondragover="handleDragOver(event)" ondrop="handleDrop(event,'portfolio',${i})" ondragend="handleDragEnd(event)">
      <div class="portfolio-item-summary" onclick="togglePortfolioItem(this)">
        <div class="portfolio-item-left">
          <span class="drag-handle" title="Drag to reorder">&#x2807;</span>
          <span class="portfolio-item-num">#${i + 1}</span>
          <span class="portfolio-item-title">${escapeHtml(title)}</span>
          <span class="portfolio-item-meta">${escapeHtml(item.client || '')} &middot; ${escapeHtml(item.mediaType || '')}</span>
        </div>
        <span class="portfolio-item-chevron">&#9654;</span>
      </div>
      <div class="portfolio-item-body">
        <div style="margin-top:12px">
          <div class="single-field">
            <div class="field-group">
              <label>ID (URL slug)</label>
              <input type="text" data-field="pf-${i}-id" value="${escapeAttr(item.id || '')}">
            </div>
          </div>
          ${bilingualField(`pf-${i}-title`, 'Title', item.title)}
          <div class="bilingual-row">
            <div class="field-group">
              <label>Client</label>
              <input type="text" data-field="pf-${i}-client" value="${escapeAttr(item.client || '')}">
            </div>
            <div class="field-group">
              <label>Media Type</label>
              ${renderMediaTypeCheckboxes(i, item.mediaType || '')}
            </div>
          </div>
          <div class="single-field">
            <div class="field-group">
              <label>Video URL (optional)</label>
              <input type="text" data-field="pf-${i}-videoUrl" value="${escapeAttr(item.videoUrl || '')}">
            </div>
          </div>
          ${bilingualTextarea(`pf-${i}-mission`, 'Mission', item.mission)}
          ${bilingualTextarea(`pf-${i}-solution`, 'Solution', item.solution)}
          ${renderPortfolioImages(item, i)}
          <div class="array-item-actions" style="margin-top:12px;display:flex;gap:4px;justify-content:flex-end">
            <button class="btn-danger btn-small" onclick="removePortfolioItem(${i})">Delete</button>
          </div>
        </div>
      </div>
    </div>
  `;
}

function togglePortfolioItem(summary) {
  const item = summary.closest('.portfolio-item');
  item.classList.toggle('expanded');
}

function bindPortfolioListeners() {
  const search = document.getElementById('portfolio-search');
  if (!search) return;
  search.addEventListener('input', () => {
    const q = search.value.toLowerCase().trim();
    const items = document.querySelectorAll('.portfolio-item');
    let count = 0;
    items.forEach(item => {
      const match = !q || item.dataset.search.includes(q);
      item.style.display = match ? '' : 'none';
      if (match) count++;
    });
    document.getElementById('portfolio-count').textContent = `${count} item${count !== 1 ? 's' : ''}`;
  });
}

function collectPortfolio(data) {
  const items = document.querySelectorAll('#portfolio-items > .portfolio-item');
  const result = Array.from(items).map((el, i) => {
    const obj = {
      id: getVal(`pf-${i}-id`),
      title: getBilingual(`pf-${i}-title`),
      client: getVal(`pf-${i}-client`),
      mediaType: getMediaType(i),
      mission: getBilingual(`pf-${i}-mission`),
      solution: getBilingual(`pf-${i}-solution`),
    };
    const videoUrl = getVal(`pf-${i}-videoUrl`);
    if (videoUrl) obj.videoUrl = videoUrl;
    return obj;
  });
  fileCache.portfolio.data = result;
}

// ─── Array Mutations ──────────────────────────────────
function addFaqItem() {
  collectFormData('faq');
  fileCache.faq.data.faqData.push({ category: 'services', question: { ko: '', en: '' }, answer: { ko: '', en: '' } });
  renderEditor('faq');
}

function removeFaqItem(i) {
  collectFormData('faq');
  fileCache.faq.data.faqData.splice(i, 1);
  renderEditor('faq');
}

function moveFaqItem(i, dir) {
  collectFormData('faq');
  const arr = fileCache.faq.data.faqData;
  const j = i + dir;
  if (j < 0 || j >= arr.length) return;
  [arr[i], arr[j]] = [arr[j], arr[i]];
  renderEditor('faq');
}

function addQuoteItem() {
  collectFormData('quotes');
  fileCache.quotes.data.push({ quote: { ko: '', en: '' }, author: '', role: { ko: '', en: '' } });
  renderEditor('quotes');
}

function removeQuoteItem(i) {
  collectFormData('quotes');
  fileCache.quotes.data.splice(i, 1);
  renderEditor('quotes');
}

function moveQuoteItem(i, dir) {
  collectFormData('quotes');
  const arr = fileCache.quotes.data;
  const j = i + dir;
  if (j < 0 || j >= arr.length) return;
  [arr[i], arr[j]] = [arr[j], arr[i]];
  renderEditor('quotes');
}

function addTeamItem() {
  collectFormData('team');
  fileCache.team.data.push({
    name: { ko: '', en: '' },
    initial: '',
    role: { ko: '', en: '' },
    image: '',
    education: { ko: [], en: [] },
    experience: { ko: [], en: [] },
  });
  renderEditor('team');
}

function removeTeamItem(i) {
  collectFormData('team');
  fileCache.team.data.splice(i, 1);
  renderEditor('team');
}

function moveTeamItem(i, dir) {
  collectFormData('team');
  const arr = fileCache.team.data;
  const j = i + dir;
  if (j < 0 || j >= arr.length) return;
  [arr[i], arr[j]] = [arr[j], arr[i]];
  renderEditor('team');
}

async function uploadTeamPhoto(i) {
  const fileInput = document.getElementById(`team-${i}-photo-file`);
  const file = fileInput.files[0];
  if (!file) return;

  const objectUrl = URL.createObjectURL(file);
  const previewEl = document.getElementById(`team-${i}-photo-preview`);
  const initialVal = getVal(`team-${i}-initial`) || '';
  previewEl.innerHTML = `<div class="team-diamond"><div class="team-diamond-initial">${escapeHtml(initialVal)}</div><div class="team-diamond-shape"><img src="${objectUrl}" alt="Photo"></div></div>`;

  // Store the file as a data URL in the hidden field for now
  const reader = new FileReader();
  reader.onload = () => {
    // For team photos, we just update the image path field.
    // The user will need to upload the image file to the repo separately
    // or we can store it as a pending operation.
    // For simplicity: set image path to a conventional path and queue the upload
    const ext = file.name.split('.').pop().toLowerCase();
    const memberName = getVal(`team-${i}-name-en`) || getVal(`team-${i}-name-ko`) || `member${i}`;
    const safeName = memberName.replace(/[^a-zA-Z0-9]/g, '');
    const filename = `profile${safeName}.${ext}`;
    const repoPath = `public/assets/images/${filename}`;
    const imagePath = `/assets/images/${filename}`;

    // Update the hidden image field
    const hiddenInput = document.querySelector(`[data-field="team-${i}-image"]`);
    if (hiddenInput) hiddenInput.value = imagePath;

    // Queue image upload
    const base64 = reader.result.split(',')[1];
    pendingImageOps = pendingImageOps.filter(op =>
      !(op.action === 'upload' && op.repoPath.startsWith('public/assets/images/profile') && op.label === `team photo for ${memberName}`)
    );
    pendingImageOps.push({ action: 'upload', repoPath, base64, label: `team photo for ${memberName}` });
    updateDirtyIndicators();
  };
  reader.readAsDataURL(file);
  fileInput.value = '';
}

function addTeamEdu(memberIdx) {
  collectFormData('team');
  const member = fileCache.team.data[memberIdx];
  member.education.ko.push({ school: '', degree: '' });
  member.education.en.push({ school: '', degree: '' });
  renderEditor('team');
}

function removeTeamEdu(memberIdx, eduIdx) {
  collectFormData('team');
  const member = fileCache.team.data[memberIdx];
  member.education.ko.splice(eduIdx, 1);
  member.education.en.splice(eduIdx, 1);
  renderEditor('team');
}

function addTeamExp(memberIdx) {
  collectFormData('team');
  const member = fileCache.team.data[memberIdx];
  member.experience.ko.push('');
  member.experience.en.push('');
  renderEditor('team');
}

function removeTeamExp(memberIdx, expIdx) {
  collectFormData('team');
  const member = fileCache.team.data[memberIdx];
  member.experience.ko.splice(expIdx, 1);
  member.experience.en.splice(expIdx, 1);
  renderEditor('team');
}

// Portfolio mutations
function addPortfolioItem() {
  collectFormData('portfolio');
  fileCache.portfolio.data.push({
    id: '',
    title: { ko: '', en: '' },
    client: '',
    mediaType: '',
    mission: { ko: '', en: '' },
    solution: { ko: '', en: '' },
  });
  renderEditor('portfolio');
}

function removePortfolioItem(i) {
  if (!confirm('Delete this portfolio item?')) return;
  collectFormData('portfolio');
  fileCache.portfolio.data.splice(i, 1);
  renderEditor('portfolio');
}

function movePortfolioItem(i, dir) {
  collectFormData('portfolio');
  const arr = fileCache.portfolio.data;
  const j = i + dir;
  if (j < 0 || j >= arr.length) return;
  [arr[i], arr[j]] = [arr[j], arr[i]];
  renderEditor('portfolio');
}

// ─── HTML Helpers ─────────────────────────────────────
function bilingualField(prefix, label, data) {
  const ko = data?.ko || '';
  const en = data?.en || '';
  return `
    <div class="bilingual-row">
      <div class="field-group">
        <label class="field-label-row"><span class="lang-badge ko">KO</span> ${escapeHtml(label)}</label>
        <input type="text" data-field="${prefix}-ko" value="${escapeAttr(ko)}">
      </div>
      <div class="field-group">
        <label class="field-label-row"><span class="lang-badge en">EN</span> ${escapeHtml(label)}</label>
        <input type="text" data-field="${prefix}-en" value="${escapeAttr(en)}">
      </div>
    </div>
  `;
}

function bilingualTextarea(prefix, label, data, html = false) {
  let ko = data?.ko || '';
  let en = data?.en || '';
  // For HTML fields, show <br> as line breaks in the textarea
  if (html) {
    ko = ko.replace(/<br\s*\/?>/gi, '\n');
    en = en.replace(/<br\s*\/?>/gi, '\n');
  }
  return `
    <div class="bilingual-row">
      <div class="field-group">
        <label class="field-label-row"><span class="lang-badge ko">KO</span> ${escapeHtml(label)}</label>
        <textarea data-field="${prefix}-ko">${escapeHtml(ko)}</textarea>
      </div>
      <div class="field-group">
        <label class="field-label-row"><span class="lang-badge en">EN</span> ${escapeHtml(label)}</label>
        <textarea data-field="${prefix}-en">${escapeHtml(en)}</textarea>
      </div>
    </div>
  `;
}

function escapeHtml(str) {
  if (str == null) return '';
  return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

function escapeAttr(str) {
  if (str == null) return '';
  return String(str).replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
}

// ─── Init ─────────────────────────────────────────────
initAuth();
</script>
</body>
</html>
