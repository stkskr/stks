# Team Profile Mobile Bug Report

## Summary

On mobile devices (viewport width ≤ 768px), the team profile cards have two broken behaviors:

1. **Tap to open/close is completely broken** - Tapping a profile card does nothing, or behaves inconsistently
2. **Auto-scroll after opening is broken** - When a card does open, it should scroll to keep the expanded card visible

This functionality **was working** in a previous commit and has regressed.

---

## Expected Behavior

1. **Tap closed card** → Card expands to show `.profile-reveal` content
2. **Tap open card** → Card collapses (closes)
3. **Tap different card** → Currently open card closes, tapped card opens
4. **After opening** → Page scrolls smoothly so expanded card is fully visible

---

## Current Behavior

- Tapping cards does **nothing** most of the time
- Sometimes cards open but won't close
- Scroll functionality never triggers
- Behavior is inconsistent and unreliable

---

## Technical Context

### File Structure

| File | Purpose |
|------|---------|
| `src/components/TeamProfiles.js` | JavaScript component that creates profile cards and attaches event handlers |
| `src/styles/content.css` | Main styles including `.team-member`, `.profile-reveal`, and `.mobile-active` classes |

### HTML Structure (generated by JS)

```html
<div class="team-grid">
  <div class="team-member">  <!-- This is the "card" element -->
    <div class="diamond-wrapper">
      <div class="initial-overlay">K</div>
      <div class="diamond-shape">
        <img src="..." alt="Name" class="diamond-image">
      </div>
    </div>
    <div class="member-info">
      <h3 class="name">Name</h3>
      <p class="role">Role</p>
      <div class="profile-reveal">  <!-- This expands/collapses -->
        <div class="edu-section">...</div>
        <ul class="exp-list">...</ul>
      </div>
    </div>
  </div>
  <!-- More .team-member cards -->
</div>
```

### CSS Animation Mechanism

The expand/collapse is CSS-driven via `max-height` transition:

```css
/* Base state - collapsed */
.profile-reveal {
  max-height: 0;
  overflow: hidden;
  opacity: 0;
  transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1),
              opacity 0.3s ease;
  padding: 0 20px;
  margin-top: 20px;
  /* ... other styles */
}

/* Expanded state - triggered by .mobile-active on parent */
.team-member.mobile-active .profile-reveal {
  max-height: 500px;
  opacity: 1;
  padding: 20px;
}
```

**The JS only needs to toggle `.mobile-active` class on the `.team-member` element.**

---

## Current JavaScript Code (Not Working)

```javascript
// From src/components/TeamProfiles.js - createProfileCard method

const isMobile = () => window.innerWidth <= 768;

// Scroll card into view after expansion
const scrollCardIntoView = () => {
  setTimeout(() => {
    const cardRect = card.getBoundingClientRect();
    const viewportHeight = window.innerHeight;
    const bottomPadding = isMobile() ? 100 : 40;

    const overflow = cardRect.bottom - (viewportHeight - bottomPadding);
    if (overflow > 0) {
      const scrollElement = document.scrollingElement || document.documentElement;
      scrollElement.scrollTo({
        top: scrollElement.scrollTop + overflow,
        behavior: 'smooth'
      });
    }
  }, 450);  // Wait for CSS transition (400ms)
};

// Desktop: scroll into view on hover
card.addEventListener('mouseenter', () => {
  if (!isMobile()) {
    scrollCardIntoView();
  }
});

// Mobile: Track touch movement to distinguish tap from scroll
let touchStartY = 0;
let touchStartTime = 0;
let isTouchMoving = false;

const handleTouchStart = (e) => {
  if (isMobile()) {
    touchStartY = e.touches[0].clientY;
    touchStartTime = Date.now();
    isTouchMoving = false;
  }
};

const handleTouchMove = (e) => {
  if (isMobile()) {
    const touchMoveY = e.touches[0].clientY;
    const moveDistance = Math.abs(touchMoveY - touchStartY);

    // If moved more than 5px, consider it scrolling
    if (moveDistance > 5) {
      isTouchMoving = true;
    }
  }
};

const handleTouchEnd = (e) => {
  if (isMobile()) {
    const touchDuration = Date.now() - touchStartTime;

    // Only trigger if it's a quick tap (< 200ms) with minimal movement
    if (!isTouchMoving && touchDuration < 200) {
      e.preventDefault();
      e.stopPropagation();

      const isCurrentlyActive = card.classList.contains('mobile-active');

      // Close ALL profiles first (including this one)
      const allCards = this.element.querySelectorAll('.team-member');
      allCards.forEach(otherCard => {
        otherCard.classList.remove('mobile-active');
      });

      // If this card wasn't active, open it and scroll into view
      if (!isCurrentlyActive) {
        card.classList.add('mobile-active');
        scrollCardIntoView();
      }
    }
  }
};

// Touch event listeners for mobile
card.addEventListener('touchstart', handleTouchStart, { passive: true });
card.addEventListener('touchmove', handleTouchMove, { passive: true });
card.addEventListener('touchend', handleTouchEnd, { passive: false });
```

---

## Known Working Code (From Git History)

This is from commit `67583ec` when tap-to-toggle was working:

```javascript
// Track touch movement to distinguish tap from scroll
let touchStartY = 0;
let touchStartTime = 0;
let isTouchMoving = false;

const handleTouchStart = (e) => {
  if (isMobile()) {
    touchStartY = e.touches[0].clientY;
    touchStartTime = Date.now();
    isTouchMoving = false;
  }
};

const handleTouchMove = (e) => {
  if (isMobile()) {
    const touchMoveY = e.touches[0].clientY;
    const moveDistance = Math.abs(touchMoveY - touchStartY);

    // If moved more than 5px, consider it scrolling (stricter threshold)
    if (moveDistance > 5) {
      isTouchMoving = true;
    }
  }
};

const handleTouchEnd = (e) => {
  if (isMobile()) {
    const touchDuration = Date.now() - touchStartTime;

    // Very strict: Only trigger if it's a quick tap (< 200ms) with minimal movement
    if (!isTouchMoving && touchDuration < 200) {
      e.preventDefault();
      e.stopPropagation();

      const isCurrentlyActive = card.classList.contains('mobile-active');

      // Close all other profiles first
      const allCards = this.element.querySelectorAll('.team-member');
      allCards.forEach(otherCard => {
        otherCard.classList.remove('mobile-active');
      });

      // If this card wasn't active, open it (accordion behavior)
      if (!isCurrentlyActive) {
        card.classList.add('mobile-active');
      }
    }
  }
};

// Touch event listeners for mobile
card.addEventListener('touchstart', handleTouchStart, { passive: true });
card.addEventListener('touchmove', handleTouchMove, { passive: true });
card.addEventListener('touchend', handleTouchEnd, { passive: false });
```

**Note:** The working code did NOT have the `scrollCardIntoView()` feature - that was added later and may have introduced issues.

---

## Hypotheses for Why It's Broken

### Hypothesis 1: Touch Events Not Firing on Card Element

The touch events are bound to the `card` element (`.team-member`), but when tapping, the actual `e.target` might be a child element like `.diamond-wrapper`, `.name`, `.profile-reveal`, etc.

**Test:** Add console.log to verify events fire:
```javascript
const handleTouchEnd = (e) => {
  console.log('touchend fired on card:', card.querySelector('.name')?.textContent);
  console.log('e.target:', e.target.tagName, e.target.className);
  // ... rest of handler
};
```

### Hypothesis 2: isTouchMoving Gets Stuck as True

The 5px threshold is very tight. Even micro-movements during a tap could trigger `isTouchMoving = true`, causing the tap to be ignored.

**Test:** Log the values:
```javascript
const handleTouchEnd = (e) => {
  console.log('isTouchMoving:', isTouchMoving);
  console.log('touchDuration:', Date.now() - touchStartTime);
  // ... rest of handler
};
```

### Hypothesis 3: Touch Duration Exceeds 200ms

Mobile browsers can have delays. A normal tap might take longer than 200ms from touchstart to touchend.

**Test:** Increase threshold to 500ms and see if it helps.

### Hypothesis 4: Child Elements Intercepting Events

Something inside the card might have `pointer-events`, `touch-action`, or event handlers that interfere.

**Check CSS for:**
```css
.profile-reveal {
  pointer-events: ???;
}
```

### Hypothesis 5: `this.element` Reference is Wrong

The line `this.element.querySelectorAll('.team-member')` assumes `this.element` is the `.team-grid` container. If `this` context is lost (arrow function issue), it could fail silently.

**Test:** Log `this.element` to verify it's the grid.

### Hypothesis 6: Passive Event Listener Issue

`touchend` is registered with `{ passive: false }` to allow `e.preventDefault()`. If this isn't working, the browser might be ignoring the handler.

**Test:** Try removing `e.preventDefault()` to see if handler runs.

---

## Debugging Steps

### Step 1: Add Comprehensive Logging

Replace the touch handlers with this instrumented version:

```javascript
const handleTouchStart = (e) => {
  console.log('=== TOUCHSTART ===');
  console.log('isMobile():', isMobile());
  if (isMobile()) {
    touchStartY = e.touches[0].clientY;
    touchStartTime = Date.now();
    isTouchMoving = false;
    console.log('touchStartY:', touchStartY);
  }
};

const handleTouchMove = (e) => {
  if (isMobile()) {
    const touchMoveY = e.touches[0].clientY;
    const moveDistance = Math.abs(touchMoveY - touchStartY);
    console.log('touchmove distance:', moveDistance);
    if (moveDistance > 5) {
      isTouchMoving = true;
      console.log('>>> MARKED AS SCROLLING');
    }
  }
};

const handleTouchEnd = (e) => {
  console.log('=== TOUCHEND ===');
  console.log('isMobile():', isMobile());
  console.log('isTouchMoving:', isTouchMoving);

  if (isMobile()) {
    const touchDuration = Date.now() - touchStartTime;
    console.log('touchDuration:', touchDuration);
    console.log('passes duration check (<200):', touchDuration < 200);
    console.log('passes movement check:', !isTouchMoving);

    if (!isTouchMoving && touchDuration < 200) {
      console.log('>>> TAP DETECTED - TOGGLING');
      e.preventDefault();
      e.stopPropagation();

      const isCurrentlyActive = card.classList.contains('mobile-active');
      console.log('isCurrentlyActive:', isCurrentlyActive);

      const allCards = this.element.querySelectorAll('.team-member');
      console.log('allCards count:', allCards.length);

      allCards.forEach(otherCard => {
        otherCard.classList.remove('mobile-active');
      });

      if (!isCurrentlyActive) {
        card.classList.add('mobile-active');
        console.log('>>> OPENED CARD');
      } else {
        console.log('>>> CLOSED CARD');
      }
    } else {
      console.log('>>> TAP REJECTED');
    }
  }
};
```

### Step 2: Test with Browser DevTools

1. Open site on mobile or use Chrome DevTools device emulation
2. Open Console
3. Tap a profile card
4. Check console output to see where it fails

### Step 3: Verify Element References

```javascript
// Add at start of createProfileCard
console.log('Creating card, this.element is:', this.element);
console.log('Card element is:', card);
```

---

## Potential Fixes to Try

### Fix A: Use Click Event Instead of Touch

Click events fire on mobile after the touch sequence and are more reliable:

```javascript
// Remove all touch handlers and use this instead:
card.addEventListener('click', (e) => {
  if (!isMobile()) return;

  const isCurrentlyActive = card.classList.contains('mobile-active');

  const allCards = this.element.querySelectorAll('.team-member');
  allCards.forEach(otherCard => {
    otherCard.classList.remove('mobile-active');
  });

  if (!isCurrentlyActive) {
    card.classList.add('mobile-active');
    scrollCardIntoView();
  }
});
```

**Caveat:** This might interfere with scrolling if not gated properly.

### Fix B: Increase Thresholds

```javascript
// More lenient thresholds
const MOVE_THRESHOLD = 15;  // was 5
const TAP_DURATION_MAX = 400;  // was 200

const handleTouchMove = (e) => {
  if (isMobile()) {
    const moveDistance = Math.abs(e.touches[0].clientY - touchStartY);
    if (moveDistance > MOVE_THRESHOLD) {
      isTouchMoving = true;
    }
  }
};

const handleTouchEnd = (e) => {
  if (isMobile()) {
    const touchDuration = Date.now() - touchStartTime;
    if (!isTouchMoving && touchDuration < TAP_DURATION_MAX) {
      // ... toggle logic
    }
  }
};
```

### Fix C: Use Pointer Events API

Modern solution that handles both touch and mouse:

```javascript
let pointerStartY = 0;
let pointerStartTime = 0;
let isPointerMoving = false;

card.addEventListener('pointerdown', (e) => {
  if (!isMobile()) return;
  pointerStartY = e.clientY;
  pointerStartTime = Date.now();
  isPointerMoving = false;
});

card.addEventListener('pointermove', (e) => {
  if (!isMobile()) return;
  if (Math.abs(e.clientY - pointerStartY) > 10) {
    isPointerMoving = true;
  }
});

card.addEventListener('pointerup', (e) => {
  if (!isMobile()) return;
  const duration = Date.now() - pointerStartTime;

  if (!isPointerMoving && duration < 300) {
    const isCurrentlyActive = card.classList.contains('mobile-active');

    const allCards = this.element.querySelectorAll('.team-member');
    allCards.forEach(otherCard => {
      otherCard.classList.remove('mobile-active');
    });

    if (!isCurrentlyActive) {
      card.classList.add('mobile-active');
      scrollCardIntoView();
    }
  }
});
```

### Fix D: Bind to Document with Event Delegation

Instead of binding to each card, use event delegation:

```javascript
// In the TeamProfiles class, after render():
document.addEventListener('click', (e) => {
  if (!isMobile()) return;

  const card = e.target.closest('.team-member');
  if (!card || !this.element.contains(card)) return;

  const isCurrentlyActive = card.classList.contains('mobile-active');

  const allCards = this.element.querySelectorAll('.team-member');
  allCards.forEach(otherCard => {
    otherCard.classList.remove('mobile-active');
  });

  if (!isCurrentlyActive) {
    card.classList.add('mobile-active');
    // scrollCardIntoView for this card
  }
});
```

---

## Environment

- **Framework:** Vanilla JavaScript (ES6 modules)
- **Build:** Vite
- **Target:** Mobile Safari, Chrome Mobile
- **Breakpoint:** `window.innerWidth <= 768` defines mobile

---

## Files to Share with Helper

1. `src/components/TeamProfiles.js` - Full file
2. `src/styles/content.css` - Lines 1700-1900 (team member styles)
3. This bug report

---

## Questions for Debugging

1. Does `touchend` fire at all when tapping the card?
2. What are the actual values of `isTouchMoving` and `touchDuration` when tapping?
3. Is `this.element` correctly referencing the `.team-grid` container?
4. Are there any CSS rules (like `pointer-events: none`) blocking touch on child elements?
5. Does the click event approach work where touch doesn't?
